---
title: "DNS tips"
date: 2019-09-13T12:00:21+02:00
draft: false
categories: ["openshift", "kubernetes", "metal3", "dns", "tips"]
author: Pedro Ibáñez Requena
---

## Prerequisites
When preparing a baremetal installation in a user-provisioned DNS scenario it's important
to have the DNS configuration prepared before starting the installation. [The recommended 
DNS Server for kubernetes is CoreDNS](https://kubernetes.io/docs/tasks/administer-cluster/dns-custom-nameservers/):

> As of Kubernetes v1.12, CoreDNS is the recommended DNS Server, replacing kube-dns. However, 
kube-dns may still be installed by default with certain Kubernetes installer tools. Refer to 
the documentation provided by your installer to know which DNS server is installed by default.

## Servers data
In this example OpenShift installer would be use so the DNS configuration would be prepared before proceeding
with the installation. The following table is going to be used as an example for configuring the dns:


| Usage     | Hostname                 | IP             | NOTES                                         |
|-----------|--------------------------|----------------|-----------------------------------------------|
| Bootstrap | ocp4-bootstrap.local.lan | 10.0.0.99  | To be removed from the cluster once installed |
| Master-0  | ocp4-master-0.local.lan  | 10.0.0.100 | Master 0                                      |
| Master-1  | ocp4-master-1.local.lan  | 10.0.0.101 | Master 1                                      |
| Master-2  | ocp4-master-2.local.lan  | 10.0.0.102 | Master 2                                      |
| Worker-0  | ocp4-worker-0.local.lan  | 10.0.0.200 | Worker 0                                      |
| Helper    | ocp4-helper.local.lan    | 10.0.0.150 | DNS/HTTPD & Load Balancer                     |

The domain is: local.lan
And this setup has a cluster of 3 masters, 1 worker, the bootstrap server and a helper server running the DNS, HTTPD and a Load Balancer.
It's an example, you can configure it as you wish.

## CoreDNS configuration files
The following Corefile is an example for this configuration:
```
Corefile 
.:53 {
    log
    errors
    forward . 8.8.8.8
}

local.lan:53 {
    log
    errors
    file /etc/coredns/db.local.lan
}

```

And the db.local.lan looks like the following snippet:
```
$ORIGIN local.lan.
$TTL 10800      ; 3 hours
@       3600 IN SOA sns.dns.icann.org. noc.dns.icann.org. (
                                2019091301 ; serial
                                7200       ; refresh (2 hours)
                                3600       ; retry (1 hour)
                                1209600    ; expire (2 weeks)
                                3600       ; minimum (1 hour)
                                )

_etcd-server-ssl._tcp.ocp4.local.lan. 8640 IN    SRV 0 10 2380 etcd-0.ocp4.local.lan.
_etcd-server-ssl._tcp.ocp4.local.lan. 8640 IN    SRV 0 10 2380 etcd-1.ocp4.local.lan.
_etcd-server-ssl._tcp.ocp4.local.lan. 8640 IN    SRV 0 10 2380 etcd-2.ocp4.local.lan.

api.ocp4.local.lan.                        A                10.0.0.150
api-int.ocp4.local.lan.                    A                10.0.0.150
ocp4-master-0.local.lan.                   A                10.0.0.100
ocp4-master-1.local.lan.                   A                10.0.0.101
ocp4-master-2.local.lan.                   A                10.0.0.102
ocp4-worker-0.local.lan.                   A                10.0.0.200
ocp4-bootstrap.local.lan.                  A                10.0.0.99
etcd-0.ocp4.local.lan.                     IN  CNAME ocp4-master-0.local.lan.
etcd-1.ocp4.local.lan.                     IN  CNAME ocp4-worker-1.local.lan.
etcd-2.ocp4.local.lan.                     IN  CNAME ocp4-worker-2.local.lan.

$ORIGIN apps.ocp4.local.lan.
*                                                    A                10.0.0.150

```

Once the CoreDNS is configured and running (in a container or natively) the installation can be started.

## Warning

It's importat tho advise that in this example the servers defined in the DNS are the ones really used for installing the initial cluster, 
in the case you may want to add future masters be careful with the dns registers for the etc servers and don't define them until you really need them.
Otherwise, while you are running the bootstrap phase of your installation, the etcd cluster will autodiscover each '_etcd-server-ssl._tcp.ocp4.local.bin' server 
and will try to connect to each of them and in the case there is one that can not be reached, the cluster won't start failing the installation.


## Resources and links

* [Kubernetes dns custom nameservers](https://kubernetes.io/docs/tasks/administer-cluster/dns-custom-nameservers/)
* [OpenShift user-provisioned dns requirements](https://docs.openshift.com/container-platform/4.1/installing/installing_bare_metal/installing-bare-metal.html#installation-dns-user-infra_installing-bare-metal)
* [CoreDNS.io](https://coredns.io/)
* [etcd.io](https://etcd.io/)
