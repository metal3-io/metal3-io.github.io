---
title: "DNS tips"
date: 2019-09-13T12:00:21+02:00
draft: false
categories: ["Kubernetes", "Metal3", "DNS", "tips"]
author: Pedro Ibáñez Requena
---

## Prerequisites
When preparing a baremetal installation in a user-provisioned external DNS scenario, it's important
to have the DNS configuration prepared before starting the installation. [The recommended 
DNS Server for kubernetes is CoreDNS](https://kubernetes.io/docs/tasks/administer-cluster/dns-custom-nameservers/):

> As of Kubernetes v1.12, CoreDNS is the recommended DNS Server, replacing kube-dns. However, 
kube-dns may still be installed by default with certain Kubernetes installer tools. Refer to 
the documentation provided by your installer to know which DNS server is installed by default.

## Servers data
In this example (you can configure it to suit your needs) the DNS configuration would be prepared before proceeding
with the installation. The following table is going to be used as an example for configuring the dns:


| Usage     | Hostname                 | IP             | NOTES                                         |
|-----------|--------------------------|----------------|-----------------------------------------------|
| controller-0  | k8s-controller-0.local.lan  | 10.0.0.100     | controller 0                           |
| controller-1  | k8s-controller-1.local.lan  | 10.0.0.101     | controller 1                           |
| controller-2  | k8s-controller-2.local.lan  | 10.0.0.102     | controller 2                           |
| Worker-0  | k8s-worker-0.local.lan  | 10.0.0.200     | Worker 0                                       |
| Helper    | k8s-helper.local.lan    | 10.0.0.150     | DNS/HTTPD & Load Balancer                      |

The domain is: `local.lan` and this setup has a cluster of 3 controllers and 1 worker, the helper server is the one running the DNS, HTTPD and a Load Balancer.


## CoreDNS configuration files
The following Corefile is an example of this configuration:
```
Corefile 
.:53 {
    log
    errors
    forward . 8.8.8.8
}

local.lan:53 {
    log
    errors
    file /etc/coredns/db.local.lan
}

```

And the db.local.lan looks like the following snippet:
```
$ORIGIN local.lan.
$TTL 10800      ; 3 hours
@       3600 IN SOA sns.dns.icann.org. noc.dns.icann.org. (
                                2019091301 ; serial
                                7200       ; refresh (2 hours)
                                3600       ; retry (1 hour)
                                1209600    ; expire (2 weeks)
                                3600       ; minimum (1 hour)
                                )

_etcd-server-ssl._tcp.local.lan. 8640 IN    SRV 0 10 2380 etcd-0.k8s.local.lan.
_etcd-server-ssl._tcp.local.lan. 8640 IN    SRV 0 10 2380 etcd-1.k8s.local.lan.
_etcd-server-ssl._tcp.local.lan. 8640 IN    SRV 0 10 2380 etcd-2.k8s.local.lan.

api.k8s.local.lan.                        A                10.0.0.150
api-int.k8s.local.lan.                    A                10.0.0.150
k8s-controller-0.local.lan.               A                10.0.0.100
k8s-controller-1.local.lan.               A                10.0.0.101
k8s-controller-2.local.lan.               A                10.0.0.102
k8s-worker-0.local.lan.                   A                10.0.0.200
etcd-0.k8s.local.lan.                     IN  CNAME k8s-controller-0.local.lan.
etcd-1.k8s.local.lan.                     IN  CNAME k8s-controller-1.local.lan.
etcd-2.k8s.local.lan.                     IN  CNAME k8s-controller-2.local.lan.

$ORIGIN apps.k8s.local.lan.
*                                                    A                10.0.0.150

```

Once CoreDNS is configured and running (in a container or natively) the installation can be started.

**Warning**: It's important to notice that, in this example, the servers defined in the DNS are the ones used for installing the initial cluster.
In the case, you may want to add future controllers be careful with the DNS registers for the etc servers and don't define them **until you really need them**.
Otherwise, when you are running the bootstrap phase of your installation, the etcd cluster will auto-discover each '_etcd-server-ssl._tcp.k8s.local.bin' server 
and will try to connect to each of them, and in the case there is one that can not be reached, the cluster will fail to establish the connection, hence failing the installation.


## Resources and links

* [Kubernetes dns custom nameservers](https://kubernetes.io/docs/tasks/administer-cluster/dns-custom-nameservers/)
* [CoreDNS.io](https://coredns.io/)
* [etcd.io](https://etcd.io/)
