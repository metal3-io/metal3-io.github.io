<!doctype html>
<html class="no-js" lang="en">

<head>
    <script id="dpal" src="//www.redhat.com/ma/dpal.js" type="text/javascript"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="shortcut icon" type="image/png" href="/favicon.png">
    <meta name="theme-color" content="#008585">
    
    <title>One cluster - multiple providers | Metal³ - Metal Kubed</title>
    <!-- # Opengraph protocol properties: https://ogp.me/ -->
    <meta name="author" content="Lennart Jern" >
    <meta property="og:type" content="article" >
    <meta name="twitter:card" content="summary">
    <meta name="description" content="Metal3.io aims to build on baremetal host provisioning technologies to provide a Kubernetes native API for managing bare metal hosts via a provisioning stack that is also running on Kubernetes.">
    <meta name="keywords" content="metal3, cluster API, provider, hybrid, edge" >
    <meta property="og:title" content="One cluster - multiple providers | Metal³ - Metal Kubed">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://metal3.io/blog/2022/07/08/One_cluster_multiple_providers.html" >
    <meta property="og:image" content="https://metal3.io/assets/images/metal3logo.png">
    <meta property="og:description" content="Metal3.io aims to build on baremetal host provisioning technologies to provide a Kubernetes native API for managing bare metal hosts via a provisioning stack that is also running on Kubernetes." >
    <meta property="og:site_name" content="Metal³ - Metal Kubed" >
    <meta property="og:article:author" content="Lennart Jern" >
    <meta property="og:article:published_time" content="2022-07-08 00:00:00 -0500" >
    <meta name="twitter:title" content="One cluster - multiple providers | Metal³ - Metal Kubed">
    <meta name="twitter:description" content="Metal3.io aims to build on baremetal host provisioning technologies to provide a Kubernetes native API for managing bare metal hosts via a provisioning stack that is also running on Kubernetes.">

    <link type="application/atom+xml" rel="alternate" href="https://metal3.io/feed.xml" title="Metal³ - Metal Kubed" />
    <meta name="google-site-verification" content="HCdbGknTOCTKQVt7m-VxTG4BEYXxSqm-sDb-iklqrB0" />
  <link href="https://fonts.googleapis.com/css?family=Nunito:200,400&display=swap" rel="stylesheet">
  <script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js" integrity="sha384-3LK/3kTpDE/Pkp8gTNp2gR/2gOiwQ6QaO7Td0zV76UFJVhqLl4Vl3KL1We6q6wR9" crossorigin="anonymous"></script>
  <!-- Photoswipe.com gallery-->

  <!-- Core CSS file -->
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.css">

  <!-- Skin CSS file (styling of UI - buttons, caption, etc.)
      In the folder of skin CSS file there are also:
      - .png and .svg icons sprite,
      - preloader.gif (for browsers that do not support CSS animations) -->
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/default-skin/default-skin.min.css">
</head>
<body>
    <!--[if IE]>
      <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
    <![endif]-->

<div class="mk-wrapper">
    <section class="mk-masthead mk-masthead--sub">
<header class="mk-main-header">
    <a href="/" class="mk-main-header__brand">
        <svg version="1.1" viewBox="0 0 557 540" xmlns="http://www.w3.org/2000/svg">
          <g fill="none" fill-rule="evenodd">
            <g transform="translate(-1)" fill-rule="nonzero">
            <path d="m181.91 539.68h-0.7c-0.76 0-1.44-0.11-2-0.17h-0.14l-1.62-0.2c-15.204-1.867-29.364-8.7129-40.27-19.47l-1.07-1.06-49.46-61.26-73.34-90.59-0.5-0.72c-2.8927-4.0899-5.2989-8.503-7.17-13.15-1.0257-2.532-1.8875-5.1274-2.58-7.77v-0.11c-0.22-0.85-0.43-1.69-0.62-2.56v-0.14c-0.8042-3.5966-1.2861-7.2578-1.44-10.94v-0.47-0.48c-0.067687-4.136 0.26722-8.2688 1-12.34l0.11-0.61 14.51-63.64 28.72-126c4.0017-17.442 15.802-32.074 32-39.68l178.2-85.93 3.34-0.67c5.6926-1.1418 11.484-1.7201 17.29-1.7201h2.83 0.57c8.4518-0.016309 16.808 1.7879 24.5 5.2901l0.47 0.22 175.82 84.2 0.48 0.25c7.1101 3.7526 13.491 8.7481 18.84 14.75 2.7886 3.1018 5.2639 6.4715 7.39 10.06l0.17 0.29c2.1776 3.7964 3.9314 7.8205 5.23 12l0.3 1 44.23 190.25 0.17 1.42c2.0399 16.443-2.1677 33.052-11.79 46.54l-0.48 0.68-121.46 150.24c-7.2792 9.604-17.475 16.59-29.06 19.91-0.93 0.27-1.87 0.52-2.81 0.75l-0.3 0.07c-5.0328 1.1701-10.183 1.76-15.35 1.76h-194.01z" fill="#fff"/>
            <path d="m492 131.65c-0.75221-2.3458-1.7582-4.6025-3-6.73-1.2507-2.1148-2.7114-4.0982-4.36-5.92-3.3032-3.7145-7.2456-6.8067-11.64-9.13l-179.82-86c-4.3569-1.9816-9.0938-2.9883-13.88-2.95h-0.77c-4.9428-0.19294-9.8909 0.20318-14.74 1.18l-179.72 86.6c-8.9642 4.1124-15.498 12.17-17.67 21.79l-3.69 16.16 216.29 117.67 0.34-0.18 217.22-112.72-4.56-19.77z" fill="#00E0C1"/>
            <path d="m279 264.32l-216.29-117.67-25.77 113.1-14.73 64.63c-0.44744 2.4671-0.64178 4.9734-0.58 7.48v0.29c0.072639 2.1493 0.33702 4.2878 0.79 6.39 0.12 0.56 0.26 1.1 0.4 1.65 0.41228 1.5719 0.92671 3.1151 1.54 4.62 1.1152 2.7748 2.5517 5.4095 4.28 7.85l23.69 29.27 51 63 49.67 61.55c6.7982 6.7311 15.643 11.009 25.14 12.16 0.67 0 1.31 0.18 2 0.21h99.17v-254.34l-0.31-0.19z" fill="#00EEC4"/>
            <path d="m536.75 324.38l-40.19-173-217.23 112.76v254.71h98.82c3.2616 0.017 6.5139-0.34884 9.69-1.0906 0.62-0.15 1.23-0.31 1.84-0.49 6.2438-1.7629 11.72-5.5604 15.56-10.79l66.09-81.75 31.31-38.73 26.94-33.33c5.8432-8.2018 8.4013-18.295 7.17-28.29z" fill="#00D1BD"/>
            <path d="m120.94 369l137 75.89c1.3702 0.76284 3.0421 0.74251 4.3933-0.05344s2.1796-2.2483 2.1767-3.8166v-161.02c0-5.718-3.1489-10.971-8.19-13.67l-1.64-0.87-134.68-71.99c-0.8041-0.43178-1.7757-0.41032-2.56 0.056543-0.78426 0.46687-1.2663 1.3108-1.27 2.2235l-0.94 163.17c0.02 3.63 2.77 8.44 5.71 10.08z" fill="#fff"/>
            <path d="m282.61 103.85c-4.0372-0.033083-8.0333 0.81323-11.71 2.481l-134.2 60.47c-0.91184 0.40637-1.512 1.2973-1.5476 2.295-0.032512 0.99771 0.50554 1.9274 1.3876 2.395l135.72 72.51c0.15 0.09 0.31 0.16 0.47 0.24l0.59 0.29 0.26 0.11 0.8 0.34h0.09c4.9879 1.8704 10.539 1.5061 15.24-1l139.14-73.94c1.1079-0.5822 1.7814-1.7504 1.7328-3.0009-0.054039-1.2505-0.82096-2.3596-1.9728-2.8491l-135.06-58.05c-3.4545-1.4945-7.1761-2.2735-10.94-2.291z" fill="#fff"/>
            <path d="m442.82 192.61c-1.08-0.49333-2.4133-0.29667-4 0.59l-24.52 13.54c-3.6117 1.9922-6.3845 5.2194-7.81 9.09l-37.49 87.55-37.31-46.2c-1.59-2.29-4.2-2.45-7.81-0.45l-24.51 13.54c-1.6358 0.9266-3.0116 2.2508-4 3.85-1.0039 1.4454-1.5667 3.151-1.62 4.91v166.83c0 1.59 0.55 2.59 1.63 3s2.42 0.19 4-0.69l27.34-15.1c1.6143-0.90735 2.9864-2.1902 4-3.74 1.0178-1.3976 1.5863-3.0717 1.63-4.8v-105l23.21 30.12c2.1667 2.1267 4.6967 2.3933 7.59 0.8l11.67-6.45c3.18-1.7467 5.71-4.8067 7.59-9.18l23.43-55.9 0.25 97.1 0.17 8.31c-0.10795 1.217 0.57186 2.3675 1.69 2.86 1.2747 0.44018 2.6836 0.23517 3.78-0.55l27.27-15.83c1.5869-0.9387 2.9245-2.2455 3.9-3.81 0.9881-1.4207 1.5184-3.1095 1.5212-4.84v-166.43c0.028815-1.6-0.51118-2.64-1.6012-3.12z" fill="#fff"/>
            </g>
          </g>
        </svg>
      </a>
      <div role="navigation" class="mk-main-header__nav-wrapper">
        <button class="mk-main-header__toggle" id="toggle" aria-controls="main_nav" aria-expanded="false" aria-label="navigation toggle" >
          <svg version="1.1" viewBox="0 0 512 448" xmlns="http://www.w3.org/2000/svg">
          <g>
          <path d="m296 0h192c13.255 0 24 10.745 24 24v160c0 13.255-10.745 24-24 24h-192c-13.255 0-24-10.745-24-24v-160c0-13.255 10.745-24 24-24zm-80 0h-192c-13.255 0-24 10.745-24 24v160c0 13.255 10.745 24 24 24h192c13.255 0 24-10.745 24-24v-160c0-13.255-10.745-24-24-24zm-216 264v160c0 13.255 10.745 24 24 24h192c13.255 0 24-10.745 24-24v-160c0-13.255-10.745-24-24-24h-192c-13.255 0-24 10.745-24 24zm296 184h192c13.255 0 24-10.745 24-24v-160c0-13.255-10.745-24-24-24h-192c-13.255 0-24 10.745-24 24v160c0 13.255 10.745 24 24 24z"/>
          </g>
          </svg>
          <span class="mk-main-header__toggle-text">menu</span>
        </button>
        </div>
        <ul id="main_nav" class="mk-main-nav">
          <li ><a class="mk-main-nav__item" href="/blog/index.html">Blog</a></li>
          <li ><a class="mk-main-nav__item" href="/community-resources.html">Community Resources</a></li>
          <li ><a class="mk-main-nav__item" href="https://book.metal3.io">Documentation</a></li>
          <li ><a class="mk-main-nav__item" href="/contribute.html">Contribute</a></li>
          <li ><a class="mk-main-nav__item" href="/faqs.html">FAQs</a></li>
          <li ><a class="mk-main-nav__item" href="https://book.metal3.io/developer_environment/tryit">Try It!</a></li>
          <li  id="mk-main-nav__search">
            <form action="/search.html" method="get" autocomplete="off" class="mk-search-form">
              <div class="autocomplete" style="width:150px;">
                <input type="text" id="search-input" class="docs-search--input" placeholder="Search Term" name="query">
              </div>
              <button type="submit" id = "search-button" class = "search-button" disabled = 'true' >
                <img src="/assets/images/search.png" style="height: 20px;" alt="">
              </button>
                <div id="mode-toggle">
                  <img src="/assets/images/moon-outline.png" id="mode-icon" style="height: 20px; margin-left: 10px;"/>
                </div>
            </form>
          </li>

        </ul>
  </header>
  
<script>
function autocomplete(inp, arr) {
  /*the autocomplete function takes two arguments,
  the text field element and an array of possible autocompleted values:*/
  var currentFocus;
  /*execute a function when someone writes in the text field:*/
  inp.addEventListener("input", function(e) {
      var a, b, i, val = this.value;
      /*close any already open lists of autocompleted values*/
      closeAllLists();
      if (!val) { return false;}
      currentFocus = -1;
      /*create a DIV element that will contain the items (values):*/
      a = document.createElement("DIV");
      a.setAttribute("id", this.id + "autocomplete-list");
      a.setAttribute("class", "autocomplete-items");
      /*append the DIV element as a child of the autocomplete container:*/
      this.parentNode.appendChild(a);
      /*for each item in the array...*/
      for (i = 0; i < arr.length; i++) {
        /*check if the item starts with the same letters as the text field value:*/
        if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
          /*create a DIV element for each matching element:*/
          b = document.createElement("DIV");
          /*make the matching letters bold:*/
          b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
          b.innerHTML += arr[i].substr(val.length);
          /*insert a input field that will hold the current array item's value:*/
          b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
          /*execute a function when someone clicks on the item value (DIV element):*/
              b.addEventListener("click", function(e) {
              /*insert the value for the autocomplete text field:*/
              inp.value = this.getElementsByTagName("input")[0].value;
              /*close the list of autocompleted values,
              (or any other open lists of autocompleted values:*/
              closeAllLists();
          });
          a.appendChild(b);
        }
      }
  });
  /*execute a function presses a key on the keyboard:*/
  inp.addEventListener("keydown", function(e) {
      document.getElementById("search-button").disabled= undefined;
      var x = document.getElementById(this.id + "autocomplete-list");
      if (x) x = x.getElementsByTagName("div");
      if (e.keyCode == 40) {
        /*If the arrow DOWN key is pressed,
        increase the currentFocus variable:*/
        currentFocus++;
        /*and and make the current item more visible:*/
        addActive(x);
      } else if (e.keyCode == 38) { //up
        /*If the arrow UP key is pressed,
        decrease the currentFocus variable:*/
        currentFocus--;
        /*and and make the current item more visible:*/
        addActive(x);
      } else if (e.keyCode == 13) {
        /*If the ENTER key is pressed, prevent the form from being submitted,*/
        if (currentFocus > -1) {
          /*and simulate a click on the "active" item:*/
          if (x) {
            x[currentFocus].click();
            e.preventDefault();
          }
        }
        if (document.getElementById("search-input").value == "") {
          e.preventDefault();
        }
      }
  });
  function addActive(x) {
    /*a function to classify an item as "active":*/
    if (!x) return false;
    /*start by removing the "active" class on all items:*/
    removeActive(x);
    if (currentFocus >= x.length) currentFocus = 0;
    if (currentFocus < 0) currentFocus = (x.length - 1);
    /*add class "autocomplete-active":*/
    x[currentFocus].classList.add("autocomplete-active");
  }
  function removeActive(x) {
    /*a function to remove the "active" class from all autocomplete items:*/
    for (var i = 0; i < x.length; i++) {
      x[i].classList.remove("autocomplete-active");
    }
  }
  function closeAllLists(elmnt) {
    /*close all autocomplete lists in the document,
    except the one passed as an argument:*/
    var x = document.getElementsByClassName("autocomplete-items");
    for (var i = 0; i < x.length; i++) {
      if (elmnt != x[i] && elmnt != inp) {
      x[i].parentNode.removeChild(x[i]);
    }
  }
}
/*execute a function when someone clicks in the document:*/
document.addEventListener("click", function (e) {
    closeAllLists(e.target);
});
}
</script>
<script>
  document.addEventListener("DOMContentLoaded", function(){
  let iconMode = document.getElementById("mode-icon")
  let toggleMode = document.getElementById("mode-toggle")
  let cncfImage = document.getElementById("cncf-image")
let isToggled = localStorage.getItem("currentMode") === "true";
updateMode();
toggleMode.addEventListener("click", () => {
  isToggled = !isToggled;
  localStorage.setItem("currentMode", isToggled);
  updateMode();
});
function updateMode() {
  let mastHead = document.querySelector(".mk-masthead");
  let h1 = document.querySelectorAll("h1")
  let h2 = document.querySelectorAll("h2")
  let h3 = document.querySelectorAll("h3")
  let li = document.querySelectorAll("li")
  let sections = document.querySelectorAll(".mk-main__section")
  let body = document.querySelector("body")
  let whyCards = document.querySelectorAll(".mk-why-baremetal__card")
  let blogCards = document.querySelectorAll(".mk-blog-meta__card")
  let questions = document.querySelectorAll(".mk-faqs__question")
  let subHeadings = document.querySelectorAll(".mk-sub-heading")
  let p = document.querySelectorAll("p")
  if (isToggled) {

    iconMode.src = "/assets/images/moon-outline.png";
    cncfImage.src = "/assets/images/cncf-white.svg";
    mastHead.style.backgroundColor = "var(--mk--BackgroundColor--500)";
    body.style.backgroundColor = "var(--mk--BackgroundColor--500)";
    body.style.color = "var(--mk--Color--200)";
    h1.forEach((eachH1)=>{
      eachH1.style.color = "var(--mk--Color--200)"
    })
    h2.forEach((eachH2)=>{
      eachH2.style.color = "var(--mk--Color--200)"
    })
    h3.forEach((eachH3)=>{
      eachH3.style.color = "var(--mk--Color--200)"
    })
    li.forEach((eachLi)=>{
      eachLi.style.color = "var(--mk--Color--200)"
    })
    sections.forEach((section)=>{
      section.style.backgroundColor = "var(--mk--BackgroundColor--500)";
    })
    p.forEach((eachP)=>{
      eachP.style.color = "var(--mk--Color--200)"
    })
    whyCards.forEach((whyCard)=>{
    whyCard.querySelector("h3").style.color = "var(--mk--BackgroundColor--150)"
      whyCard.style.backgroundColor = "var(--mk--BackgroundColor--175)"
    })
    blogCards.forEach((blogCard)=>{
      blogCard.style.backgroundColor = "var(--mk--color-brand--400)";
    })
    questions.forEach((question)=>{
      question.style.color = "var(--mk--Color--200)"
    })
    subHeadings.forEach((subHeading)=>{
      subHeading.style.color = "var(--mk--Color--500)"
    })
  } else {
    iconMode.src = "/assets/images/moon.png";
    cncfImage.src = "/assets/images/cncf-color.svg";
    mastHead.style.backgroundColor = "";
    body.style.backgroundColor = "";
    body.style.color = "var(--mk--Color--400)";


    h1.forEach((eachH1)=>{
      eachH1.style.color = ""
    })
    h2.forEach((eachH2)=>{
      eachH2.style.color = ""
    })
    h3.forEach((eachH3)=>{
      eachH3.style.color = ""
    })
    sections.forEach((section)=>{
      section.style.backgroundColor = "var(--mk--BackgroundColor--250)";
    })
    li.forEach((eachLi)=>{
      eachLi.style.color = ""
    })
    p.forEach((eachP)=>{
      eachP.style.color = ""
    })
    whyCards.forEach((whyCard)=>{
      whyCard.querySelector("h3").style.color = ""
      whyCard.style.backgroundColor = "white"
    })
    blogCards.forEach((blogCard)=>{
      blogCard.style.backgroundColor = ""
    })
    questions.forEach((question)=>{
      question.style.color = ""
    })
    subHeadings.forEach((subHeading)=>{
      subHeading.style.color = "var(--mk--Color--500)"
    })


  }
}
})
</script>
<script>
var mykeywords = ["hybrid", "cloud", "metal3", "baremetal", "stack", "edge", "openstack", "ironic", "openshift", "kubernetes", "OpenStack", "operator", "summit", "kubecon", "shiftdev", "metal3-dev-env", "documentation", "development", "talk", "conference", "meetup", "cluster API", "provider", "raw image", "image streaming", "IPAM", "ip address manager", "Pivoting", "Move", "scaling", "cncf", "community", "announcement", ]
autocomplete(document.getElementById("search-input"), mykeywords);
</script>
<script src="/assets/js/clipboard.min.js"></script>
<!-- Photoswipe -->
<!-- Core JS file -->
<script src="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.js"></script>
<!-- UI JS file -->
<script src="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<div class="mk-masthead__content--sub">
        <h1 class="mk-masthead__content--sub__title">Blog</h1>
        <p class="mk-masthead__content--sub__text">Read about the newest updates in the community.</p>
</div>
</section>
<main class="mk-main mk-blog">
            <article class="mk-main__section mk-main__content mk-main__section__content">
                    <h1 class="mk-heading--lg mk-heading mk-m-border mk-blog__post__title">One cluster - multiple providers</h1>
                    <time datetime="1999-12-23" class="mk-blog-meta__timestamp mk-blog-meta__item mk-blog-meta__timestamp--light">Friday, 8/07/2022</time>
                    <div class="mk-blog-meta__item mk-blog-meta__author">By Lennart Jern</div>
                    <div class="mk-blog-meta__categories">
                                
                                <a class="mk-blog-meta__item mk-blog-meta__category" href="/blog/categories.html#metal3">
                                  metal3
                                </a>
                              
                                <a class="mk-blog-meta__item mk-blog-meta__category" href="/blog/categories.html#cluster-api">
                                  cluster-api
                                </a>
                              
                                <a class="mk-blog-meta__item mk-blog-meta__category" href="/blog/categories.html#provider">
                                  provider
                                </a>
                              
                                <a class="mk-blog-meta__item mk-blog-meta__category" href="/blog/categories.html#hybrid">
                                  hybrid
                                </a>
                              
                                <a class="mk-blog-meta__item mk-blog-meta__category" href="/blog/categories.html#edge">
                                  edge
                                </a>
                              
                </div>

<div class="mk-share-buttons">

           <!-- <a class="mk-share-buttons__item" href="https://www.facebook.com/sharer/sharer.php?u=https://metal3.io/blog/2022/07/08/One_cluster_multiple_providers.html"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on Facebook" >
            <?xml version="1.0" encoding="UTF-8"?>
<svg enable-background="new 0 0 1024 1024" version="1.1" viewBox="0 0 1024 1024" xml:space="preserve" xmlns="http://www.w3.org/2000/svg">
	<path d="M1024,512C1024,229.2,794.8,0,512,0S0,229.2,0,512c0,255.6,187.2,467.4,432,505.8V660H302V512h130V399.2   C432,270.9,508.4,200,625.4,200c56,0,114.6,10,114.6,10v126h-64.6c-63.6,0-83.4,39.5-83.4,80v96h142l-22.7,148H592v357.8   C836.8,979.4,1024,767.6,1024,512z"/>
	<path class="st0" d="M711.3,660L734,512H592v-96c0-40.5,19.8-80,83.4-80H740V210c0,0-58.6-10-114.6-10   c-117,0-193.4,70.9-193.4,199.2V512H302v148h130v357.8c26.1,4.1,52.8,6.2,80,6.2s53.9-2.1,80-6.2V660H711.3z"/>
</svg>Share on Facebook</a> -->


        <a class="mk-share-buttons__item" href="https://twitter.com/intent/tweet?text=One cluster - multiple providers&url=https://metal3.io/blog/2022/07/08/One_cluster_multiple_providers.html"
        onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
        title="Share on Twitter" >
        <?xml version="1.0" encoding="UTF-8"?>
<svg enable-background="new 0 0 250 203.1" version="1.1" viewBox="0 0 250 203.1" xml:space="preserve" xmlns="http://www.w3.org/2000/svg">
<path class="st1" d="m78.6 203.1c94.3 0 145.9-78.2 145.9-145.9 0-2.2 0-4.4-0.1-6.6 10-7.3 18.7-16.3 25.6-26.5-9.4 4.1-19.3 6.9-29.5 8.1 10.7-6.4 18.7-16.5 22.5-28.4-10.1 6-21.1 10.2-32.6 12.4-19.4-20.7-51.9-21.7-72.6-2.2-13.3 12.5-19 31.2-14.8 49-41.1-2.1-79.6-21.6-105.6-53.6-13.6 23.4-6.7 53.4 15.9 68.4-8.2-0.2-16.1-2.4-23.3-6.4v0.6c0 24.4 17.2 45.4 41.2 50.3-7.6 2.1-15.5 2.4-23.2 0.9 6.7 20.9 26 35.2 47.9 35.6-18.2 14.3-40.6 22-63.7 22-4.1 0-8.2-0.3-12.2-0.7 23.5 15.1 50.7 23 78.6 23"/>
</svg> Share on Twitter
    </a>
</div>
        <p>Running on bare metal has both benefits and drawbacks. You can get the
best performance possible out of the hardware, but it can also be quite
expensive and maybe not necessary for <em>all</em> workloads. Perhaps a hybrid
cluster could give you the best of both? Raw power for the workload that
needs it, and cheap virtualized commodity for the rest. This blog post
will show how to set up a cluster like this using the Cluster API backed
by the Metal3 and BYOH providers.</p>

<h2 id="the-problem">The problem</h2>

<p>Imagine that you have some bare metal servers that you want to use for
some specific workload. Maybe the workload benefits from the specific
hardware or there are some requirements that make it necessary to run it
there. The rest of the organization already uses Kubernetes and the
cluster API everywhere so of course you want the same for this as well.
Perfect, grab Metal³ and start working!</p>

<p>But hold on, this would mean that you use some of the servers for
running the Kubernetes control plane and possibly all the cluster API
controllers. If there are enough servers this is probably not an issue,
but do you really want to “waste” these servers on such generic
workloads that could be running anywhere? This can become especially
painful if you need multiple control plane nodes. Each server is
probably powerful enough to run all the control planes and controllers,
but it would be a single point of failure…</p>

<p>What if there was a way to use a different cluster API infrastructure
provider for some nodes? For example, use the Openstack infrastructure
provider for the control plane and Metal³ for the workers. Let’s do an
experiment!</p>

<h2 id="setting-up-the-experiment-environment">Setting up the experiment environment</h2>

<p>This blog post will use the <a href="https://github.com/vmware-tanzu/cluster-api-provider-bringyourownhost">Bring your own
host</a>
(BYOH) provider together with Metal³ as a proof of concept to show what
is currently possible.</p>

<p>The BYOH provider was chosen as the second provider for two reasons:</p>

<ol>
  <li>Due to its design (you provision the host yourself), it is very easy
to adapt it to the test (e.g. use a VM in the same network that the
metal3-dev-env uses).</li>
  <li>It is one of the providers that is known to work when combining
multiple providers for a single cluster.</li>
</ol>

<p>We will be using the
<a href="https://github.com/metal3-io/metal3-dev-env">metal3-dev-env</a> on Ubuntu
as a starting point for this experiment. Note that it makes substantial
changes to the machine where it is running, so you may want to use a
dedicated lab machine instead of your laptop for this. If you have not
done so already, clone it and run <code class="language-plaintext highlighter-rouge">make</code>. This should give you a
management cluster with the Metal³ provider installed and two
BareMetalHosts ready for provisioning.</p>

<p>The next step is to add the BYOH provider and a ByoHost.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="syntax"><code>clusterctl init <span class="nt">--infrastructure</span> byoh
</code></pre></div></div>

<p>For the ByoHost we will use Vagrant.
You can install it with <code class="language-plaintext highlighter-rouge">sudo apt install vagrant</code>.
Then copy the Vagrantfile below to a new folder and run <code class="language-plaintext highlighter-rouge">vagrant up</code>.</p>

<pre><code class="language-Vagrantfile"># -*- mode: ruby -*-
hosts = {
    "control-plane1" =&gt; { "memory" =&gt; 2048, "ip" =&gt; "192.168.10.10"},
    # "control-plane2" =&gt; { "memory" =&gt; 2048, "ip" =&gt; "192.168.10.11"},
    # "control-plane3" =&gt; { "memory" =&gt; 2048, "ip" =&gt; "192.168.10.12"},
}


Vagrant.configure("2") do |config|
    # Choose which box you want below
    config.vm.box = "generic/ubuntu2004"
    config.vm.synced_folder ".", "/vagrant", disabled: true
    config.vm.provider :libvirt do |libvirt|
      # QEMU system connection is required for private network configuration
      libvirt.qemu_use_session = false
    end


    # Loop over all machine names
    hosts.each_key do |host|
        config.vm.define host, primary: host == hosts.keys.first do |node|
            node.vm.hostname = host
            node.vm.network :private_network, ip: hosts[host]["ip"],
              libvirt__forward_mode: "route"
            node.vm.provider :libvirt do |lv|
                lv.memory = hosts[host]["memory"]
                lv.cpus = 2
            end
        end
    end
end
</code></pre>

<p>Vagrant should now have created a new VM to use as a ByoHost. Now we
just need to run the BYOH agent in the VM to make it register as a
ByoHost in the management cluster. The BYOH agent needs a kubeconfig
file to do this, so we start by copying it to the VM:</p>

<!-- markdownlint-disable MD013 -->

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="nb">cp</span> ~/.kube/config ~/.kube/management-cluster.conf
<span class="c"># Ensure that the correct IP is used (not localhost)</span>
<span class="nb">export </span><span class="nv">KIND_IP</span><span class="o">=</span><span class="si">$(</span>docker inspect <span class="nt">-f</span> <span class="s1">'{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}'</span> kind-control-plane<span class="si">)</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/    server\:.*/    server\: https\:\/\/'</span><span class="s2">"</span><span class="nv">$KIND_IP</span><span class="s2">"</span><span class="s1">'\:6443/g'</span> ~/.kube/management-cluster.conf
scp <span class="nt">-i</span> .vagrant/machines/control-plane1/libvirt/private_key <span class="se">\</span>
  /home/ubuntu/.kube/management-cluster.conf vagrant@192.168.10.10:management-cluster.conf

</code></pre></div></div>

<!-- markdownlint-enable MD013 -->

<p>Next, install the prerequisites and host agent in the VM and run it.</p>

<!-- markdownlint-enable MD013 -->

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="syntax"><code>vagrant ssh
<span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> socat ebtables ethtool conntrack
wget https://github.com/vmware-tanzu/cluster-api-provider-bringyourownhost/releases/download/v0.2.0/byoh-hostagent-linux-amd64
<span class="nb">mv </span>byoh-hostagent-linux-amd64 byoh-hostagent
<span class="nb">chmod</span> +x byoh-hostagent
<span class="nb">sudo</span> ./byoh-hostagent <span class="nt">--namespace</span> metal3 <span class="nt">--kubeconfig</span> management-cluster.conf
</code></pre></div></div>

<!-- markdownlint-disable MD013 -->

<p>You should now have a management cluster with both the Metal³ and BYOH
providers installed, as well as two BareMetalHosts and one ByoHost.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="gp">$</span><span class="w"> </span>kubectl <span class="nt">-n</span> metal3 get baremetalhosts,byohosts
<span class="go">NAME                             STATE       CONSUMER   ONLINE   ERROR   AGE
baremetalhost.metal3.io/node-0   available              true             18m
baremetalhost.metal3.io/node-1   available              true             18m


NAME                                                     AGE
byohost.infrastructure.cluster.x-k8s.io/control-plane1   73s
</span></code></pre></div></div>

<h2 id="creating-a-multi-provider-cluster">Creating a multi-provider cluster</h2>

<p>The trick is to create both a Metal3Cluster and a ByoCluster that are
owned by one common Cluster. We will use the ByoCluster for the control
plane in this case. First the Cluster:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">cluster.x-k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Cluster</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">cni</span><span class="pi">:</span> <span class="s">mixed-cluster-crs-0</span>
    <span class="na">crs</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mixed-cluster</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">clusterNetwork</span><span class="pi">:</span>
    <span class="na">pods</span><span class="pi">:</span>
      <span class="na">cidrBlocks</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">192.168.0.0/16</span>
    <span class="na">serviceDomain</span><span class="pi">:</span> <span class="s">cluster.local</span>
    <span class="na">services</span><span class="pi">:</span>
      <span class="na">cidrBlocks</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">10.128.0.0/12</span>
  <span class="na">controlPlaneRef</span><span class="pi">:</span>
    <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">controlplane.cluster.x-k8s.io/v1beta1</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">KubeadmControlPlane</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">mixed-cluster-control-plane</span>
  <span class="na">infrastructureRef</span><span class="pi">:</span>
    <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">infrastructure.cluster.x-k8s.io/v1beta1</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">ByoCluster</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">mixed-cluster</span>
</code></pre></div></div>

<p>Add the rest of the BYOH manifests to get a control plane.
The code is collapsed here for easier reading.
Please click on the line below to expand it.</p>

<!-- markdownlint-disable MD033 -->

<details>
  <summary>KubeadmControlPlane, ByoCluster and ByoMachineTemplate</summary>
  <!-- Enable markdown parsing of the content. -->
  <div>

    <!-- markdownlint-enable MD033 -->

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">controlplane.cluster.x-k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">KubeadmControlPlane</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">nodepool</span><span class="pi">:</span> <span class="s">pool0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mixed-cluster-control-plane</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">kubeadmConfigSpec</span><span class="pi">:</span>
    <span class="na">clusterConfiguration</span><span class="pi">:</span>
      <span class="na">apiServer</span><span class="pi">:</span>
        <span class="na">certSANs</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">localhost</span>
          <span class="pi">-</span> <span class="s">127.0.0.1</span>
          <span class="pi">-</span> <span class="s">0.0.0.0</span>
          <span class="pi">-</span> <span class="s">host.docker.internal</span>
      <span class="na">controllerManager</span><span class="pi">:</span>
        <span class="na">extraArgs</span><span class="pi">:</span>
          <span class="na">enable-hostpath-provisioner</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
    <span class="na">files</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">content</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">apiVersion: v1</span>
          <span class="s">kind: Pod</span>
          <span class="s">metadata:</span>
            <span class="s">creationTimestamp: null</span>
            <span class="s">name: kube-vip</span>
            <span class="s">namespace: kube-system</span>
          <span class="s">spec:</span>
            <span class="s">containers:</span>
            <span class="s">- args:</span>
              <span class="s">- start</span>
              <span class="s">env:</span>
              <span class="s">- name: vip_arp</span>
                <span class="s">value: "true"</span>
              <span class="s">- name: vip_leaderelection</span>
                <span class="s">value: "true"</span>
              <span class="s">- name: vip_address</span>
                <span class="s">value: 192.168.10.20</span>
              <span class="s">- name: vip_interface</span>
                <span class="s">value: {{ .DefaultNetworkInterfaceName }}</span>
              <span class="s">- name: vip_leaseduration</span>
                <span class="s">value: "15"</span>
              <span class="s">- name: vip_renewdeadline</span>
                <span class="s">value: "10"</span>
              <span class="s">- name: vip_retryperiod</span>
                <span class="s">value: "2"</span>
              <span class="s">image: ghcr.io/kube-vip/kube-vip:v0.3.5</span>
              <span class="s">imagePullPolicy: IfNotPresent</span>
              <span class="s">name: kube-vip</span>
              <span class="s">resources: {}</span>
              <span class="s">securityContext:</span>
                <span class="s">capabilities:</span>
                  <span class="s">add:</span>
                  <span class="s">- NET_ADMIN</span>
                  <span class="s">- SYS_TIME</span>
              <span class="s">volumeMounts:</span>
              <span class="s">- mountPath: /etc/kubernetes/admin.conf</span>
                <span class="s">name: kubeconfig</span>
            <span class="s">hostNetwork: true</span>
            <span class="s">volumes:</span>
            <span class="s">- hostPath:</span>
                <span class="s">path: /etc/kubernetes/admin.conf</span>
                <span class="s">type: FileOrCreate</span>
              <span class="s">name: kubeconfig</span>
          <span class="s">status: {}</span>
        <span class="na">owner</span><span class="pi">:</span> <span class="s">root:root</span>
        <span class="na">path</span><span class="pi">:</span> <span class="s">/etc/kubernetes/manifests/kube-vip.yaml</span>
    <span class="na">initConfiguration</span><span class="pi">:</span>
      <span class="na">nodeRegistration</span><span class="pi">:</span>
        <span class="na">criSocket</span><span class="pi">:</span> <span class="s">/var/run/containerd/containerd.sock</span>
        <span class="na">ignorePreflightErrors</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">Swap</span>
          <span class="pi">-</span> <span class="s">DirAvailable--etc-kubernetes-manifests</span>
          <span class="pi">-</span> <span class="s">FileAvailable--etc-kubernetes-kubelet.conf</span>
    <span class="na">joinConfiguration</span><span class="pi">:</span>
      <span class="na">nodeRegistration</span><span class="pi">:</span>
        <span class="na">criSocket</span><span class="pi">:</span> <span class="s">/var/run/containerd/containerd.sock</span>
        <span class="na">ignorePreflightErrors</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">Swap</span>
          <span class="pi">-</span> <span class="s">DirAvailable--etc-kubernetes-manifests</span>
          <span class="pi">-</span> <span class="s">FileAvailable--etc-kubernetes-kubelet.conf</span>
  <span class="na">machineTemplate</span><span class="pi">:</span>
    <span class="na">infrastructureRef</span><span class="pi">:</span>
      <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">infrastructure.cluster.x-k8s.io/v1beta1</span>
      <span class="na">kind</span><span class="pi">:</span> <span class="s">ByoMachineTemplate</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">mixed-cluster-control-plane</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">v1.23.5</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">infrastructure.cluster.x-k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ByoCluster</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mixed-cluster</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">bundleLookupBaseRegistry</span><span class="pi">:</span> <span class="s">projects.registry.vmware.com/cluster_api_provider_bringyourownhost</span>
  <span class="na">bundleLookupTag</span><span class="pi">:</span> <span class="s">v1.23.5</span>
  <span class="na">controlPlaneEndpoint</span><span class="pi">:</span>
    <span class="na">host</span><span class="pi">:</span> <span class="s">192.168.10.20</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">6443</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">infrastructure.cluster.x-k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ByoMachineTemplate</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mixed-cluster-control-plane</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span> <span class="pi">{}</span>

</code></pre></div>    </div>

  </div>
</details>

<p>So far this is a “normal” Cluster backed by the BYOH provider. But now
it is time to do something different. Instead of adding more ByoHosts as
workers, we will add a Metal3Cluster and MachineDeployment backed by
BareMetalHosts! Note that the <code class="language-plaintext highlighter-rouge">controlPlaneEndpoint</code> of the
Metal3Cluster must point to the same endpoint that the ByoCluster is
using.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">infrastructure.cluster.x-k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Metal3Cluster</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mixed-cluster</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">controlPlaneEndpoint</span><span class="pi">:</span>
    <span class="na">host</span><span class="pi">:</span> <span class="s">192.168.10.20</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">6443</span>
  <span class="na">noCloudProvider</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div></div>

<!-- markdownlint-disable MD033 -->

<details>
  <summary>IPPools</summary>
  <div>

    <!-- markdownlint-enable MD033 -->

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">ipam.metal3.io/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">IPPool</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">provisioning-pool</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">clusterName</span><span class="pi">:</span> <span class="s">mixed-cluster</span>
  <span class="na">namePrefix</span><span class="pi">:</span> <span class="s">test1-prov</span>
  <span class="na">pools</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">end</span><span class="pi">:</span> <span class="s">172.22.0.200</span>
      <span class="na">start</span><span class="pi">:</span> <span class="s">172.22.0.100</span>
  <span class="na">prefix</span><span class="pi">:</span> <span class="m">24</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">ipam.metal3.io/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">IPPool</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">baremetalv4-pool</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">clusterName</span><span class="pi">:</span> <span class="s">mixed-cluster</span>
  <span class="na">gateway</span><span class="pi">:</span> <span class="s">192.168.111.1</span>
  <span class="na">namePrefix</span><span class="pi">:</span> <span class="s">test1-bmv4</span>
  <span class="na">pools</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">end</span><span class="pi">:</span> <span class="s">192.168.111.200</span>
      <span class="na">start</span><span class="pi">:</span> <span class="s">192.168.111.100</span>
  <span class="na">prefix</span><span class="pi">:</span> <span class="m">24</span>
</code></pre></div>    </div>

  </div>
</details>

<p>These manifests are quite large but they are just the same as would be
used by the metal3-dev-env with some name changes here and there. The
key thing to note is that all references to a Cluster are to the one we
defined above. Here is the MachineDeployment:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">cluster.x-k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">MachineDeployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">cluster.x-k8s.io/cluster-name</span><span class="pi">:</span> <span class="s">mixed-cluster</span>
    <span class="na">nodepool</span><span class="pi">:</span> <span class="s">nodepool-0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">test1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">clusterName</span><span class="pi">:</span> <span class="s">mixed-cluster</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">cluster.x-k8s.io/cluster-name</span><span class="pi">:</span> <span class="s">mixed-cluster</span>
      <span class="na">nodepool</span><span class="pi">:</span> <span class="s">nodepool-0</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">cluster.x-k8s.io/cluster-name</span><span class="pi">:</span> <span class="s">mixed-cluster</span>
        <span class="na">nodepool</span><span class="pi">:</span> <span class="s">nodepool-0</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">bootstrap</span><span class="pi">:</span>
        <span class="na">configRef</span><span class="pi">:</span>
          <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">bootstrap.cluster.x-k8s.io/v1beta1</span>
          <span class="na">kind</span><span class="pi">:</span> <span class="s">KubeadmConfigTemplate</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">test1-workers</span>
      <span class="na">clusterName</span><span class="pi">:</span> <span class="s">mixed-cluster</span>
      <span class="na">infrastructureRef</span><span class="pi">:</span>
        <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">infrastructure.cluster.x-k8s.io/v1beta1</span>
        <span class="na">kind</span><span class="pi">:</span> <span class="s">Metal3MachineTemplate</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">test1-workers</span>
      <span class="na">nodeDrainTimeout</span><span class="pi">:</span> <span class="s">0s</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">v1.23.5</span>
</code></pre></div></div>

<p>Finally, we add the Metal3MachineTemplate, Metal3DataTemplate and
KubeadmConfigTemplate. Here you may want to add your public ssh key in
the KubeadmConfigTemplate (the last few lines).</p>

<!-- markdownlint-disable MD033 -->

<details>
  <summary>Metal3MachineTemplate, Metal3DataTemplate and KubeadmConfigTemplate</summary>
  <!-- Enable markdown parsing of the content. -->
  <div>

    <!-- markdownlint-enable MD033 -->

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">infrastructure.cluster.x-k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Metal3MachineTemplate</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">test1-workers</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">dataTemplate</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">test1-workers-template</span>
      <span class="na">image</span><span class="pi">:</span>
        <span class="na">checksum</span><span class="pi">:</span> <span class="s">http://172.22.0.1/images/UBUNTU_22.04_NODE_IMAGE_K8S_v1.23.5-raw.img.md5sum</span>
        <span class="na">checksumType</span><span class="pi">:</span> <span class="s">md5</span>
        <span class="na">format</span><span class="pi">:</span> <span class="s">raw</span>
        <span class="na">url</span><span class="pi">:</span> <span class="s">http://172.22.0.1/images/UBUNTU_22.04_NODE_IMAGE_K8S_v1.23.5-raw.img</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">infrastructure.cluster.x-k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Metal3DataTemplate</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">test1-workers-template</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">metal3</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">clusterName</span><span class="pi">:</span> <span class="s">mixed-cluster</span>
  <span class="na">metaData</span><span class="pi">:</span>
    <span class="na">ipAddressesFromIPPool</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">provisioningIP</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">provisioning-pool</span>
    <span class="na">objectNames</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">name</span>
        <span class="na">object</span><span class="pi">:</span> <span class="s">machine</span>
      <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">local-hostname</span>
        <span class="na">object</span><span class="pi">:</span> <span class="s">machine</span>
      <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">local_hostname</span>
        <span class="na">object</span><span class="pi">:</span> <span class="s">machine</span>
    <span class="na">prefixesFromIPPool</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">provisioningCIDR</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">provisioning-pool</span>
  <span class="na">networkData</span><span class="pi">:</span>
    <span class="na">links</span><span class="pi">:</span>
      <span class="na">ethernets</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">id</span><span class="pi">:</span> <span class="s">enp1s0</span>
          <span class="na">macAddress</span><span class="pi">:</span>
            <span class="na">fromHostInterface</span><span class="pi">:</span> <span class="s">enp1s0</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">phy</span>
        <span class="pi">-</span> <span class="na">id</span><span class="pi">:</span> <span class="s">enp2s0</span>
          <span class="na">macAddress</span><span class="pi">:</span>
            <span class="na">fromHostInterface</span><span class="pi">:</span> <span class="s">enp2s0</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">phy</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="na">ipv4</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">id</span><span class="pi">:</span> <span class="s">baremetalv4</span>
          <span class="na">ipAddressFromIPPool</span><span class="pi">:</span> <span class="s">baremetalv4-pool</span>
          <span class="na">link</span><span class="pi">:</span> <span class="s">enp2s0</span>
          <span class="na">routes</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">gateway</span><span class="pi">:</span>
                <span class="na">fromIPPool</span><span class="pi">:</span> <span class="s">baremetalv4-pool</span>
              <span class="na">network</span><span class="pi">:</span> <span class="s">0.0.0.0</span>
              <span class="na">prefix</span><span class="pi">:</span> <span class="m">0</span>
    <span class="na">services</span><span class="pi">:</span>
      <span class="na">dns</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">8.8.8.8</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">bootstrap.cluster.x-k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">KubeadmConfigTemplate</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">test1-workers</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">files</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">content</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">network:</span>
              <span class="s">version: 2</span>
              <span class="s">renderer: networkd</span>
              <span class="s">bridges:</span>
                <span class="s">ironicendpoint:</span>
                  <span class="s">interfaces: [enp1s0]</span>
                  <span class="s">addresses:</span>
                  <span class="s">- {{ ds.meta_data.provisioningIP }}/{{ ds.meta_data.provisioningCIDR }}</span>
          <span class="na">owner</span><span class="pi">:</span> <span class="s">root:root</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">/etc/netplan/52-ironicendpoint.yaml</span>
          <span class="na">permissions</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0644"</span>
        <span class="pi">-</span> <span class="na">content</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">[registries.search]</span>
            <span class="s">registries = ['docker.io']</span>


            <span class="s">[registries.insecure]</span>
            <span class="s">registries = ['192.168.111.1:5000']</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">/etc/containers/registries.conf</span>
      <span class="na">joinConfiguration</span><span class="pi">:</span>
        <span class="na">nodeRegistration</span><span class="pi">:</span>
          <span class="na">kubeletExtraArgs</span><span class="pi">:</span>
            <span class="na">cgroup-driver</span><span class="pi">:</span> <span class="s">systemd</span>
            <span class="na">container-runtime</span><span class="pi">:</span> <span class="s">remote</span>
            <span class="na">container-runtime-endpoint</span><span class="pi">:</span> <span class="s">unix:///var/run/crio/crio.sock</span>
            <span class="na">feature-gates</span><span class="pi">:</span> <span class="s">AllAlpha=false</span>
            <span class="na">node-labels</span><span class="pi">:</span> <span class="s">metal3.io/uuid={{ ds.meta_data.uuid }}</span>
            <span class="na">provider-id</span><span class="pi">:</span> <span class="s">metal3://{{ ds.meta_data.uuid }}</span>
            <span class="na">runtime-request-timeout</span><span class="pi">:</span> <span class="s">5m</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">ds.meta_data.name</span><span class="nv"> </span><span class="s">}}"</span>
      <span class="na">preKubeadmCommands</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">netplan apply</span>
        <span class="pi">-</span> <span class="s">systemctl enable --now crio kubelet</span>
      <span class="na">users</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">metal3</span>
          <span class="c1"># sshAuthorizedKeys:</span>
          <span class="c1"># - add your public key here for debugging</span>
          <span class="na">sudo</span><span class="pi">:</span> <span class="s">ALL=(ALL) NOPASSWD:ALL</span>

</code></pre></div>    </div>

  </div>
</details>

<p>The result of all this is a Cluster with two Machines, one from the
Metal³ provider and one from the BYOH provider.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="gp">$</span><span class="w"> </span>k <span class="nt">-n</span> metal3 get machine
<span class="go">NAME                                CLUSTER         NODENAME                PROVIDERID                                      PHASE     AGE     VERSION
mixed-cluster-control-plane-48qmm   mixed-cluster   control-plane1          byoh://control-plane1/jf5uye                    Running   7m41s   v1.23.5
test1-8767dbccd-24cl5               mixed-cluster   test1-8767dbccd-24cl5   metal3://0642d832-3a7c-4ce9-833e-a629a60a455c   Running   7m18s   v1.23.5
</span></code></pre></div></div>

<p>Let’s also check that the workload cluster is functioning as expected.
Get the kubeconfig and add Calico as CNI.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="syntax"><code>clusterctl get kubeconfig <span class="nt">-n</span> metal3 mixed-cluster <span class="o">&gt;</span> kubeconfig.yaml
<span class="nb">export </span><span class="nv">KUBECONFIG</span><span class="o">=</span>kubeconfig.yaml
kubectl apply <span class="nt">-f</span> https://docs.projectcalico.org/v3.20/manifests/calico.yaml
</code></pre></div></div>

<p>Now check the nodes.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="gp">$</span><span class="w"> </span>kubectl get nodes
<span class="go">NAME                    STATUS   ROLES                  AGE   VERSION
control-plane1          Ready    control-plane,master   88m   v1.23.5
</span><span class="gp">test1-8767dbccd-24cl5   Ready    &lt;none&gt;</span><span class="w">                 </span>82m   v1.23.5
</code></pre></div></div>

<p>Going back to the management cluster, we can inspect the state of the
cluster API resources.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="gp">$</span><span class="w"> </span>clusterctl <span class="nt">-n</span> metal3 describe cluster mixed-cluster
<span class="go">NAME                                                                        READY  SEVERITY  REASON  SINCE  MESSAGE
Cluster/mixed-cluster                                                       True                     13m
├─ClusterInfrastructure - ByoCluster/mixed-cluster
├─ControlPlane - KubeadmControlPlane/mixed-cluster-control-plane            True                     13m
│ └─Machine/mixed-cluster-control-plane-hp2fp                               True                     13m
│   └─MachineInfrastructure - ByoMachine/mixed-cluster-control-plane-vxft5
└─Workers
  └─MachineDeployment/test1                                                 True                     3m57s
    └─Machine/test1-7f77dfb7c8-j7x4q                                        True                     9m32s
</span></code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>As we have seen in this post, it is possible to combine at least some
infrastructure providers when creating a single cluster. This can be
useful for example if a provider has a high cost or limited resources.
Furthermore, the use case is not addressed by MachineDeployments since
they would all be from the same provider (even though they can have
different properties).</p>

<p>There is some room for development and improvement though. The most
obvious thing is perhaps that Clusters only have one
<code class="language-plaintext highlighter-rouge">infrastructureRef</code>. This means that the cluster API controllers are not
aware of the “secondary” infrastructure provider(s).</p>

<p>Another thing that may be less obvious is the reliance on Nodes and
Machines in the Kubeadm control plane provider. It is not an issue in
the example we have seen here since both Metal³ and BYOH creates Nodes.
However, there are some projects where Nodes are unnecessary. See for
example <a href="https://github.com/clastix/kamaji">Kamaji</a>, which aims to
integrate with the cluster API. The idea here is to run the control
plane components in the management cluster as Pods. Naturally, there
would not be any control plane Nodes or Machines in this case. (A second
provider would be used to add workers.) But the Kubeadm control plane
provider expects there to be both Machines and Nodes for the control
plane, so a new provider is likely needed to make this work as desired.</p>

<p>This issue can already be seen in the
<a href="https://github.com/loft-sh/cluster-api-provider-vcluster">vcluster</a>
provider, where the Cluster stays in <code class="language-plaintext highlighter-rouge">Provisioning</code> state because it is
“Waiting for the first control plane machine to have its
<code class="language-plaintext highlighter-rouge">status.nodeRef</code> set”. The idea with vcluster is to reuse the Nodes of
the management cluster but provide a separate control plane. This gives
users better isolation than just namespaces without the need for another
“real” cluster. It is for example possible to have different custom
resource definitions in each vcluster. But since vcluster runs all the
pods (including the control plane) in the management cluster, there will
never be a control plane Machine or <code class="language-plaintext highlighter-rouge">nodeRef</code>.</p>

<p>There is already one implementation of a control plane provider without
Nodes, i.e. the EKS provider. Perhaps this is the way forward. One
implementation for each specific case. It would be nice if it was
possible to do it in a more generic way though, similar to how the
Kubeadm control plane provider is used by almost all infrastructure
providers.</p>

<p>To summarize, there is already some support for mixed clusters with
multiple providers. However, there are some issues that make it
unnecessarily awkward. Two things that could be improved in the cluster
API would be the following:</p>

<ol>
  <li>Make the <code class="language-plaintext highlighter-rouge">cluster.infrastructureRef</code> into a list to allow multiple
infrastructure providers to be registered.</li>
  <li>Drop the assumption that there will always be control plane Machines
and Nodes (e.g. by implementing a new control plane provider).</li>
</ol>

</article>
<nav class="mk-pagination">
        
          <a class="mk-pagination__page mk-pagination__page--prev" href="/blog/2021/05/05/Pivoting.html" aria-label="previous page">
                <?xml version="1.0" encoding="UTF-8"?>
                <svg enable-background="new 0 0 398.7 320.1" version="1.1" viewBox="0 0 398.7 320.1" xml:space="preserve" xmlns="http://www.w3.org/2000/svg">
                <path d="m199 143.1l136-136c9.4-9.4 24.6-9.4 33.9 0l22.6 22.6c9.4 9.4 9.4 24.6 0 33.9l-96.3 96.5 96.4 96.4c9.4 9.4 9.4 24.6 0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9 0l-136-136c-9.5-9.3-9.5-24.6-0.1-33.9zm-192 34l136 136c9.4 9.4 24.6 9.4 33.9 0l22.6-22.6c9.4-9.4 9.4-24.6 0-33.9l-96.3-96.5 96.4-96.4c9.4-9.4 9.4-24.6 0-33.9l-22.6-22.7c-9.4-9.4-24.6-9.4-33.9 0l-136 136c-9.5 9.3-9.5 24.6-0.1 34z"/>
                </svg>
          </a>
        
        
          <a class="mk-pagination__page mk-pagination__page--next" href="/blog/2023/05/05/Scaling_part_1.html" aria-label="next page">
                <?xml version="1.0" encoding="UTF-8"?>
                <svg enable-background="new 0 0 398.6 320.1" version="1.1" viewBox="0 0 398.6 320.1" xml:space="preserve" xmlns="http://www.w3.org/2000/svg">
                <path d="m199.6 177.1l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.7c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.5-96.3c-9.4-9.4-9.4-24.6 0-33.9l22.6-22.8c9.4-9.4 24.6-9.4 33.9 0l136 136c9.4 9.3 9.4 24.6 0.1 34zm191.9-34l-136-136c-9.4-9.4-24.6-9.4-33.9 0l-22.6 22.5c-9.4 9.4-9.4 24.6 0 33.9l96.4 96.4-96.4 96.4c-9.4 9.4-9.4 24.6 0 33.9l22.6 22.6c9.4 9.4 24.6 9.4 33.9 0l136-136c9.4-9.2 9.4-24.4 0-33.7z"/>
                </svg>
          </a>
        
</nav>

        <aside class="mk-blog__categories mk-main__aside">
    <header class="mk-main__header">
            <h2 class="mk-heading mk-heading--xl mk-m-border">Related entries</h2>
    </header>
    <ul class="mk-blog__related-entries">

        
        
        
        
            
            
            
            
          
            
            
            
            
              <li class="mk-blog__related-entries__item"><a class="mk-blog__related-entries__link" href="/blog/2024/12/13/Introducing-BMO-E2E.html">Introducing Baremetal Operator end-to-end test suite</a></li>
              
              
            
          
            
            
            
            
              <li class="mk-blog__related-entries__item"><a class="mk-blog__related-entries__link" href="/blog/2024/10/24/Scaling-Kubernetes-with-Metal3-on-Fake-Node.html">Scaling Kubernetes with Metal3: Simulating 1000 Clusters with Fake Ironic Agents</a></li>
              
              
            
          
            
            
            
            
              <li class="mk-blog__related-entries__item"><a class="mk-blog__related-entries__link" href="/blog/2024/05/30/Scaling_part_3.html">Scaling to 1000 clusters - Part 3</a></li>
              
              
            
          
            
            
            
            
          
            
            
            
            
          
            
            
            
            
              <li class="mk-blog__related-entries__item"><a class="mk-blog__related-entries__link" href="/blog/2023/05/17/Scaling_part_2.html">Scaling to 1000 clusters - Part 2</a></li>
              
              
                
    </ul>

</aside>

    </main>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>
<script src="/assets/js/photoswipe-page.js">
</script>

</main>
<footer class="mk-main-footer">
  <div>
    <div class="mk-cncf-footer">
      <p>We are a <a href="https://cncf.io/">Cloud Native Computing Foundation</a> sandbox project.</p>
      <p><img id= "cncf-image" src="/assets/images/cncf-color.png"/></p>
      <p>Copyright 2025 The Metal³ Contributors - <a href="/privacy-statement.html">Privacy Statement</a></p>
      <p>Copyright 2025 The Linux Foundation. All Rights Reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage">Trademark Usage</a> page.</p>
    </div>
      <div class="mk-icons-footer">
        <p>
<!--           <a href="https://twitter.com/metal3_io" aria-label="Visit us on Twitter">
            <i class="fab fa-twitter fa-lg"></i>
          </a> -->
          <a href="https://kubernetes.slack.com/messages/CHD49TLE7" data-placement="top" title="Join our Slack channel">
            <i class="fab fa-slack fa-lg"></i>
          </a>
          <a href="https://github.com/metal3-io" aria-label="View our repo on GitHub">
            <i class="fab fa-github fa-lg"></i>
          </a>
          <a href="https://groups.google.com/g/metal3-dev" aria-label="Send us an email">
            <i class="fas fa-envelope fa-lg"></i>
          </a>
          <a href="https://www.youtube.com/channel/UC_xneeYbo-Dl4g-U78xW15g/videos" aria-label="See our YouTube channel">
            <i class="fab fa-youtube fa-lg"></i>
          </a>
        </p>
      </div>
  </div>
</footer>
</div><!--wrapper-->
<script>
var toggle = document.querySelector('#toggle');
var menu = document.querySelector('#main_nav');
var menuItems = document.querySelectorAll('#main_nav li a');

toggle.addEventListener('click', function(){
if (menu.classList.contains('is-active')) {
  this.setAttribute('aria-expanded', 'false');
  menu.classList.remove('is-active');
} else {
  menu.classList.add('is-active');
  this.setAttribute('aria-expanded', 'true');
  //menuItems[0].focus();
}
});
</script>
    <script src="/assets/js/copy.js"></script>
    <!-- This comes from DTM/DPAL and must be latest entry in body-->
<script>
  let pageLocation = window.location.href
  let footerIcons = document.querySelector(".mk-icons-footer")

  if(pageLocation.includes("community-resources.html")){
    footerIcons.style.display = "none"
  }else {null}

</script>
    <script type="text/javascript">
        if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
            _satellite.pageBottom();
        }
    </script>
</body>
</html>

