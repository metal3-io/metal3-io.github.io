<!doctype html>
<html class="no-js" lang="en">

<head>
    <script id="dpal" src="//www.redhat.com/ma/dpal.js" type="text/javascript"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="shortcut icon" type="image/png" href="/favicon.png">
    <meta name="theme-color" content="#008585">
    
    <title>Metal³ development environment walkthrough part 2: Deploying a new bare metal cluster | Metal³ - Metal Kubed</title>
    <!-- # Opengraph protocol properties: https://ogp.me/ -->
    <meta name="author" content="Himanshu Roy" >
    <meta property="og:type" content="article" >
    <meta name="twitter:card" content="summary">
    <meta name="description" content="Metal3.io aims to build on baremetal host provisioning technologies to provide a Kubernetes native API for managing bare metal hosts via a provisioning stack that is also running on Kubernetes.">
    <meta name="keywords" content="metal3, kubernetes, cluster API, metal3-dev-env" >
    <meta property="og:title" content="Metal³ development environment walkthrough part 2: Deploying a new bare metal cluster | Metal³ - Metal Kubed">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://metal3.io/blog/2020/06/18/Metal3-dev-env-BareMetal-Cluster-Deployment.html" >
    <meta property="og:image" content="https://metal3.io/assets/images/metal3logo.png">
    <meta property="og:description" content="Metal3.io aims to build on baremetal host provisioning technologies to provide a Kubernetes native API for managing bare metal hosts via a provisioning stack that is also running on Kubernetes." >
    <meta property="og:site_name" content="Metal³ - Metal Kubed" >
    <meta property="og:article:author" content="Himanshu Roy" >
    <meta property="og:article:published_time" content="2020-06-18 00:00:00 -0500" >
    <meta name="twitter:title" content="Metal³ development environment walkthrough part 2: Deploying a new bare metal cluster | Metal³ - Metal Kubed">
    <meta name="twitter:description" content="Metal3.io aims to build on baremetal host provisioning technologies to provide a Kubernetes native API for managing bare metal hosts via a provisioning stack that is also running on Kubernetes.">

    <link type="application/atom+xml" rel="alternate" href="https://metal3.io/feed.xml" title="Metal³ - Metal Kubed" />
    <meta name="google-site-verification" content="HCdbGknTOCTKQVt7m-VxTG4BEYXxSqm-sDb-iklqrB0" />
  <link href="https://fonts.googleapis.com/css?family=Nunito:200,400&display=swap" rel="stylesheet">
  <script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js" integrity="sha384-3LK/3kTpDE/Pkp8gTNp2gR/2gOiwQ6QaO7Td0zV76UFJVhqLl4Vl3KL1We6q6wR9" crossorigin="anonymous"></script>
  <!-- Photoswipe.com gallery-->

  <!-- Core CSS file -->
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.css">

  <!-- Skin CSS file (styling of UI - buttons, caption, etc.)
      In the folder of skin CSS file there are also:
      - .png and .svg icons sprite,
      - preloader.gif (for browsers that do not support CSS animations) -->
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/default-skin/default-skin.min.css">
</head>
<body>
    <!--[if IE]>
      <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
    <![endif]-->

<div class="mk-wrapper">
    <section class="mk-masthead mk-masthead--sub">
<header class="mk-main-header">
    <a href="/" class="mk-main-header__brand">
        <svg version="1.1" viewBox="0 0 557 540" xmlns="http://www.w3.org/2000/svg">
          <g fill="none" fill-rule="evenodd">
            <g transform="translate(-1)" fill-rule="nonzero">
            <path d="m181.91 539.68h-0.7c-0.76 0-1.44-0.11-2-0.17h-0.14l-1.62-0.2c-15.204-1.867-29.364-8.7129-40.27-19.47l-1.07-1.06-49.46-61.26-73.34-90.59-0.5-0.72c-2.8927-4.0899-5.2989-8.503-7.17-13.15-1.0257-2.532-1.8875-5.1274-2.58-7.77v-0.11c-0.22-0.85-0.43-1.69-0.62-2.56v-0.14c-0.8042-3.5966-1.2861-7.2578-1.44-10.94v-0.47-0.48c-0.067687-4.136 0.26722-8.2688 1-12.34l0.11-0.61 14.51-63.64 28.72-126c4.0017-17.442 15.802-32.074 32-39.68l178.2-85.93 3.34-0.67c5.6926-1.1418 11.484-1.7201 17.29-1.7201h2.83 0.57c8.4518-0.016309 16.808 1.7879 24.5 5.2901l0.47 0.22 175.82 84.2 0.48 0.25c7.1101 3.7526 13.491 8.7481 18.84 14.75 2.7886 3.1018 5.2639 6.4715 7.39 10.06l0.17 0.29c2.1776 3.7964 3.9314 7.8205 5.23 12l0.3 1 44.23 190.25 0.17 1.42c2.0399 16.443-2.1677 33.052-11.79 46.54l-0.48 0.68-121.46 150.24c-7.2792 9.604-17.475 16.59-29.06 19.91-0.93 0.27-1.87 0.52-2.81 0.75l-0.3 0.07c-5.0328 1.1701-10.183 1.76-15.35 1.76h-194.01z" fill="#fff"/>
            <path d="m492 131.65c-0.75221-2.3458-1.7582-4.6025-3-6.73-1.2507-2.1148-2.7114-4.0982-4.36-5.92-3.3032-3.7145-7.2456-6.8067-11.64-9.13l-179.82-86c-4.3569-1.9816-9.0938-2.9883-13.88-2.95h-0.77c-4.9428-0.19294-9.8909 0.20318-14.74 1.18l-179.72 86.6c-8.9642 4.1124-15.498 12.17-17.67 21.79l-3.69 16.16 216.29 117.67 0.34-0.18 217.22-112.72-4.56-19.77z" fill="#00E0C1"/>
            <path d="m279 264.32l-216.29-117.67-25.77 113.1-14.73 64.63c-0.44744 2.4671-0.64178 4.9734-0.58 7.48v0.29c0.072639 2.1493 0.33702 4.2878 0.79 6.39 0.12 0.56 0.26 1.1 0.4 1.65 0.41228 1.5719 0.92671 3.1151 1.54 4.62 1.1152 2.7748 2.5517 5.4095 4.28 7.85l23.69 29.27 51 63 49.67 61.55c6.7982 6.7311 15.643 11.009 25.14 12.16 0.67 0 1.31 0.18 2 0.21h99.17v-254.34l-0.31-0.19z" fill="#00EEC4"/>
            <path d="m536.75 324.38l-40.19-173-217.23 112.76v254.71h98.82c3.2616 0.017 6.5139-0.34884 9.69-1.0906 0.62-0.15 1.23-0.31 1.84-0.49 6.2438-1.7629 11.72-5.5604 15.56-10.79l66.09-81.75 31.31-38.73 26.94-33.33c5.8432-8.2018 8.4013-18.295 7.17-28.29z" fill="#00D1BD"/>
            <path d="m120.94 369l137 75.89c1.3702 0.76284 3.0421 0.74251 4.3933-0.05344s2.1796-2.2483 2.1767-3.8166v-161.02c0-5.718-3.1489-10.971-8.19-13.67l-1.64-0.87-134.68-71.99c-0.8041-0.43178-1.7757-0.41032-2.56 0.056543-0.78426 0.46687-1.2663 1.3108-1.27 2.2235l-0.94 163.17c0.02 3.63 2.77 8.44 5.71 10.08z" fill="#fff"/>
            <path d="m282.61 103.85c-4.0372-0.033083-8.0333 0.81323-11.71 2.481l-134.2 60.47c-0.91184 0.40637-1.512 1.2973-1.5476 2.295-0.032512 0.99771 0.50554 1.9274 1.3876 2.395l135.72 72.51c0.15 0.09 0.31 0.16 0.47 0.24l0.59 0.29 0.26 0.11 0.8 0.34h0.09c4.9879 1.8704 10.539 1.5061 15.24-1l139.14-73.94c1.1079-0.5822 1.7814-1.7504 1.7328-3.0009-0.054039-1.2505-0.82096-2.3596-1.9728-2.8491l-135.06-58.05c-3.4545-1.4945-7.1761-2.2735-10.94-2.291z" fill="#fff"/>
            <path d="m442.82 192.61c-1.08-0.49333-2.4133-0.29667-4 0.59l-24.52 13.54c-3.6117 1.9922-6.3845 5.2194-7.81 9.09l-37.49 87.55-37.31-46.2c-1.59-2.29-4.2-2.45-7.81-0.45l-24.51 13.54c-1.6358 0.9266-3.0116 2.2508-4 3.85-1.0039 1.4454-1.5667 3.151-1.62 4.91v166.83c0 1.59 0.55 2.59 1.63 3s2.42 0.19 4-0.69l27.34-15.1c1.6143-0.90735 2.9864-2.1902 4-3.74 1.0178-1.3976 1.5863-3.0717 1.63-4.8v-105l23.21 30.12c2.1667 2.1267 4.6967 2.3933 7.59 0.8l11.67-6.45c3.18-1.7467 5.71-4.8067 7.59-9.18l23.43-55.9 0.25 97.1 0.17 8.31c-0.10795 1.217 0.57186 2.3675 1.69 2.86 1.2747 0.44018 2.6836 0.23517 3.78-0.55l27.27-15.83c1.5869-0.9387 2.9245-2.2455 3.9-3.81 0.9881-1.4207 1.5184-3.1095 1.5212-4.84v-166.43c0.028815-1.6-0.51118-2.64-1.6012-3.12z" fill="#fff"/>
            </g>
          </g>
        </svg>
      </a>
      <div role="navigation" class="mk-main-header__nav-wrapper">
        <button class="mk-main-header__toggle" id="toggle" aria-controls="main_nav" aria-expanded="false" aria-label="navigation toggle" >
          <svg version="1.1" viewBox="0 0 512 448" xmlns="http://www.w3.org/2000/svg">
          <g>
          <path d="m296 0h192c13.255 0 24 10.745 24 24v160c0 13.255-10.745 24-24 24h-192c-13.255 0-24-10.745-24-24v-160c0-13.255 10.745-24 24-24zm-80 0h-192c-13.255 0-24 10.745-24 24v160c0 13.255 10.745 24 24 24h192c13.255 0 24-10.745 24-24v-160c0-13.255-10.745-24-24-24zm-216 264v160c0 13.255 10.745 24 24 24h192c13.255 0 24-10.745 24-24v-160c0-13.255-10.745-24-24-24h-192c-13.255 0-24 10.745-24 24zm296 184h192c13.255 0 24-10.745 24-24v-160c0-13.255-10.745-24-24-24h-192c-13.255 0-24 10.745-24 24v160c0 13.255 10.745 24 24 24z"/>
          </g>
          </svg>
          <span class="mk-main-header__toggle-text">menu</span>
        </button>
        </div>
        <ul id="main_nav" class="mk-main-nav">
          <li ><a class="mk-main-nav__item" href="/blog/index.html">Blog</a></li>
          <li ><a class="mk-main-nav__item" href="/community-resources.html">Community Resources</a></li>
          <li ><a class="mk-main-nav__item" href="https://book.metal3.io">Documentation</a></li>
          <li ><a class="mk-main-nav__item" href="/contribute.html">Contribute</a></li>
          <li ><a class="mk-main-nav__item" href="/faqs.html">FAQs</a></li>
          <li ><a class="mk-main-nav__item" href="https://book.metal3.io/developer_environment/tryit">Try It!</a></li>
          <li  id="mk-main-nav__search">
            <form action="/search.html" method="get" autocomplete="off" class="mk-search-form">
              <div class="autocomplete" style="width:150px;">
                <input type="text" id="search-input" class="docs-search--input" placeholder="Search Term" name="query">
              </div>
              <button type="submit" id = "search-button" class = "search-button" disabled = 'true' >
                <img src="/assets/images/search.png" style="height: 20px;" alt="">
              </button>
                <div id="mode-toggle">
                  <img src="/assets/images/moon-outline.png" id="mode-icon" style="height: 20px; margin-left: 10px;"/>
                </div>
            </form>
          </li>

        </ul>
  </header>
  
<script>
function autocomplete(inp, arr) {
  /*the autocomplete function takes two arguments,
  the text field element and an array of possible autocompleted values:*/
  var currentFocus;
  /*execute a function when someone writes in the text field:*/
  inp.addEventListener("input", function(e) {
      var a, b, i, val = this.value;
      /*close any already open lists of autocompleted values*/
      closeAllLists();
      if (!val) { return false;}
      currentFocus = -1;
      /*create a DIV element that will contain the items (values):*/
      a = document.createElement("DIV");
      a.setAttribute("id", this.id + "autocomplete-list");
      a.setAttribute("class", "autocomplete-items");
      /*append the DIV element as a child of the autocomplete container:*/
      this.parentNode.appendChild(a);
      /*for each item in the array...*/
      for (i = 0; i < arr.length; i++) {
        /*check if the item starts with the same letters as the text field value:*/
        if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
          /*create a DIV element for each matching element:*/
          b = document.createElement("DIV");
          /*make the matching letters bold:*/
          b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
          b.innerHTML += arr[i].substr(val.length);
          /*insert a input field that will hold the current array item's value:*/
          b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
          /*execute a function when someone clicks on the item value (DIV element):*/
              b.addEventListener("click", function(e) {
              /*insert the value for the autocomplete text field:*/
              inp.value = this.getElementsByTagName("input")[0].value;
              /*close the list of autocompleted values,
              (or any other open lists of autocompleted values:*/
              closeAllLists();
          });
          a.appendChild(b);
        }
      }
  });
  /*execute a function presses a key on the keyboard:*/
  inp.addEventListener("keydown", function(e) {
      document.getElementById("search-button").disabled= undefined;
      var x = document.getElementById(this.id + "autocomplete-list");
      if (x) x = x.getElementsByTagName("div");
      if (e.keyCode == 40) {
        /*If the arrow DOWN key is pressed,
        increase the currentFocus variable:*/
        currentFocus++;
        /*and and make the current item more visible:*/
        addActive(x);
      } else if (e.keyCode == 38) { //up
        /*If the arrow UP key is pressed,
        decrease the currentFocus variable:*/
        currentFocus--;
        /*and and make the current item more visible:*/
        addActive(x);
      } else if (e.keyCode == 13) {
        /*If the ENTER key is pressed, prevent the form from being submitted,*/
        if (currentFocus > -1) {
          /*and simulate a click on the "active" item:*/
          if (x) {
            x[currentFocus].click();
            e.preventDefault();
          }
        }
        if (document.getElementById("search-input").value == "") {
          e.preventDefault();
        }
      }
  });
  function addActive(x) {
    /*a function to classify an item as "active":*/
    if (!x) return false;
    /*start by removing the "active" class on all items:*/
    removeActive(x);
    if (currentFocus >= x.length) currentFocus = 0;
    if (currentFocus < 0) currentFocus = (x.length - 1);
    /*add class "autocomplete-active":*/
    x[currentFocus].classList.add("autocomplete-active");
  }
  function removeActive(x) {
    /*a function to remove the "active" class from all autocomplete items:*/
    for (var i = 0; i < x.length; i++) {
      x[i].classList.remove("autocomplete-active");
    }
  }
  function closeAllLists(elmnt) {
    /*close all autocomplete lists in the document,
    except the one passed as an argument:*/
    var x = document.getElementsByClassName("autocomplete-items");
    for (var i = 0; i < x.length; i++) {
      if (elmnt != x[i] && elmnt != inp) {
      x[i].parentNode.removeChild(x[i]);
    }
  }
}
/*execute a function when someone clicks in the document:*/
document.addEventListener("click", function (e) {
    closeAllLists(e.target);
});
}
</script>
<script>
  document.addEventListener("DOMContentLoaded", function(){
  let iconMode = document.getElementById("mode-icon")
  let toggleMode = document.getElementById("mode-toggle")
  let cncfImage = document.getElementById("cncf-image")
let isToggled = localStorage.getItem("currentMode") === "true";
updateMode();
toggleMode.addEventListener("click", () => {
  isToggled = !isToggled;
  localStorage.setItem("currentMode", isToggled);
  updateMode();
});
function updateMode() {
  let mastHead = document.querySelector(".mk-masthead");
  let h1 = document.querySelectorAll("h1")
  let h2 = document.querySelectorAll("h2")
  let h3 = document.querySelectorAll("h3")
  let li = document.querySelectorAll("li")
  let sections = document.querySelectorAll(".mk-main__section")
  let body = document.querySelector("body")
  let whyCards = document.querySelectorAll(".mk-why-baremetal__card")
  let blogCards = document.querySelectorAll(".mk-blog-meta__card")
  let questions = document.querySelectorAll(".mk-faqs__question")
  let subHeadings = document.querySelectorAll(".mk-sub-heading")
  let p = document.querySelectorAll("p")
  if (isToggled) {

    iconMode.src = "/assets/images/moon-outline.png";
    cncfImage.src = "/assets/images/cncf-white.svg";
    mastHead.style.backgroundColor = "var(--mk--BackgroundColor--500)";
    body.style.backgroundColor = "var(--mk--BackgroundColor--500)";
    body.style.color = "var(--mk--Color--200)";
    h1.forEach((eachH1)=>{
      eachH1.style.color = "var(--mk--Color--200)"
    })
    h2.forEach((eachH2)=>{
      eachH2.style.color = "var(--mk--Color--200)"
    })
    h3.forEach((eachH3)=>{
      eachH3.style.color = "var(--mk--Color--200)"
    })
    li.forEach((eachLi)=>{
      eachLi.style.color = "var(--mk--Color--200)"
    })
    sections.forEach((section)=>{
      section.style.backgroundColor = "var(--mk--BackgroundColor--500)";
    })
    p.forEach((eachP)=>{
      eachP.style.color = "var(--mk--Color--200)"
    })
    whyCards.forEach((whyCard)=>{
    whyCard.querySelector("h3").style.color = "var(--mk--BackgroundColor--150)"
      whyCard.style.backgroundColor = "var(--mk--BackgroundColor--175)"
    })
    blogCards.forEach((blogCard)=>{
      blogCard.style.backgroundColor = "var(--mk--color-brand--400)";
    })
    questions.forEach((question)=>{
      question.style.color = "var(--mk--Color--200)"
    })
    subHeadings.forEach((subHeading)=>{
      subHeading.style.color = "var(--mk--Color--500)"
    })
  } else {
    iconMode.src = "/assets/images/moon.png";
    cncfImage.src = "/assets/images/cncf-color.svg";
    mastHead.style.backgroundColor = "";
    body.style.backgroundColor = "";
    body.style.color = "var(--mk--Color--400)";


    h1.forEach((eachH1)=>{
      eachH1.style.color = ""
    })
    h2.forEach((eachH2)=>{
      eachH2.style.color = ""
    })
    h3.forEach((eachH3)=>{
      eachH3.style.color = ""
    })
    sections.forEach((section)=>{
      section.style.backgroundColor = "var(--mk--BackgroundColor--250)";
    })
    li.forEach((eachLi)=>{
      eachLi.style.color = ""
    })
    p.forEach((eachP)=>{
      eachP.style.color = ""
    })
    whyCards.forEach((whyCard)=>{
      whyCard.querySelector("h3").style.color = ""
      whyCard.style.backgroundColor = "white"
    })
    blogCards.forEach((blogCard)=>{
      blogCard.style.backgroundColor = ""
    })
    questions.forEach((question)=>{
      question.style.color = ""
    })
    subHeadings.forEach((subHeading)=>{
      subHeading.style.color = "var(--mk--Color--500)"
    })


  }
}
})
</script>
<script>
var mykeywords = ["hybrid", "cloud", "metal3", "baremetal", "stack", "edge", "openstack", "ironic", "openshift", "kubernetes", "OpenStack", "operator", "summit", "kubecon", "shiftdev", "metal3-dev-env", "documentation", "development", "talk", "conference", "meetup", "cluster API", "provider", "raw image", "image streaming", "IPAM", "ip address manager", "Pivoting", "Move", "scaling", "cncf", "community", "announcement", ]
autocomplete(document.getElementById("search-input"), mykeywords);
</script>
<script src="/assets/js/clipboard.min.js"></script>
<!-- Photoswipe -->
<!-- Core JS file -->
<script src="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.js"></script>
<!-- UI JS file -->
<script src="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<div class="mk-masthead__content--sub">
        <h1 class="mk-masthead__content--sub__title">Blog</h1>
        <p class="mk-masthead__content--sub__text">Read about the newest updates in the community.</p>
</div>
</section>
<main class="mk-main mk-blog">
            <article class="mk-main__section mk-main__content mk-main__section__content">
                    <h1 class="mk-heading--lg mk-heading mk-m-border mk-blog__post__title">Metal³ development environment walkthrough part 2: Deploying a new bare metal cluster</h1>
                    <time datetime="1999-12-23" class="mk-blog-meta__timestamp mk-blog-meta__item mk-blog-meta__timestamp--light">Thursday, 18/06/2020</time>
                    <div class="mk-blog-meta__item mk-blog-meta__author">By Himanshu Roy</div>
                    <div class="mk-blog-meta__categories">
                                
                                <a class="mk-blog-meta__item mk-blog-meta__category" href="/blog/categories.html#metal3">
                                  metal3
                                </a>
                              
                                <a class="mk-blog-meta__item mk-blog-meta__category" href="/blog/categories.html#kubernetes">
                                  kubernetes
                                </a>
                              
                                <a class="mk-blog-meta__item mk-blog-meta__category" href="/blog/categories.html#cluster-api">
                                  cluster-api
                                </a>
                              
                                <a class="mk-blog-meta__item mk-blog-meta__category" href="/blog/categories.html#metal3-dev-env">
                                  metal3-dev-env
                                </a>
                              
                </div>

<div class="mk-share-buttons">

           <!-- <a class="mk-share-buttons__item" href="https://www.facebook.com/sharer/sharer.php?u=https://metal3.io/blog/2020/06/18/Metal3-dev-env-BareMetal-Cluster-Deployment.html"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on Facebook" >
            <?xml version="1.0" encoding="UTF-8"?>
<svg enable-background="new 0 0 1024 1024" version="1.1" viewBox="0 0 1024 1024" xml:space="preserve" xmlns="http://www.w3.org/2000/svg">
	<path d="M1024,512C1024,229.2,794.8,0,512,0S0,229.2,0,512c0,255.6,187.2,467.4,432,505.8V660H302V512h130V399.2   C432,270.9,508.4,200,625.4,200c56,0,114.6,10,114.6,10v126h-64.6c-63.6,0-83.4,39.5-83.4,80v96h142l-22.7,148H592v357.8   C836.8,979.4,1024,767.6,1024,512z"/>
	<path class="st0" d="M711.3,660L734,512H592v-96c0-40.5,19.8-80,83.4-80H740V210c0,0-58.6-10-114.6-10   c-117,0-193.4,70.9-193.4,199.2V512H302v148h130v357.8c26.1,4.1,52.8,6.2,80,6.2s53.9-2.1,80-6.2V660H711.3z"/>
</svg>Share on Facebook</a> -->


        <a class="mk-share-buttons__item" href="https://twitter.com/intent/tweet?text=Metal³ development environment walkthrough part 2: Deploying a new bare metal cluster&url=https://metal3.io/blog/2020/06/18/Metal3-dev-env-BareMetal-Cluster-Deployment.html"
        onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
        title="Share on Twitter" >
        <?xml version="1.0" encoding="UTF-8"?>
<svg enable-background="new 0 0 250 203.1" version="1.1" viewBox="0 0 250 203.1" xml:space="preserve" xmlns="http://www.w3.org/2000/svg">
<path class="st1" d="m78.6 203.1c94.3 0 145.9-78.2 145.9-145.9 0-2.2 0-4.4-0.1-6.6 10-7.3 18.7-16.3 25.6-26.5-9.4 4.1-19.3 6.9-29.5 8.1 10.7-6.4 18.7-16.5 22.5-28.4-10.1 6-21.1 10.2-32.6 12.4-19.4-20.7-51.9-21.7-72.6-2.2-13.3 12.5-19 31.2-14.8 49-41.1-2.1-79.6-21.6-105.6-53.6-13.6 23.4-6.7 53.4 15.9 68.4-8.2-0.2-16.1-2.4-23.3-6.4v0.6c0 24.4 17.2 45.4 41.2 50.3-7.6 2.1-15.5 2.4-23.2 0.9 6.7 20.9 26 35.2 47.9 35.6-18.2 14.3-40.6 22-63.7 22-4.1 0-8.2-0.3-12.2-0.7 23.5 15.1 50.7 23 78.6 23"/>
</svg> Share on Twitter
    </a>
</div>
        <h2 id="introduction">Introduction</h2>

<p>This blog post describes how to deploy a bare metal cluster, a virtual
one for simplicity, using
<a href="https://github.com/metal3-io/metal3-dev-env">Metal³/metal3-dev-env</a>. We
will briefly discuss the steps involved in setting up the cluster as
well as some of the customization available. If you want to know more
about the architecture of Metal³, this <a href="/blog/2020/02/27/talk-kubernetes-finland-metal3.html">blogpost</a> can be helpful.</p>

<p>This post builds upon the <a href="/blog/2020/02/18/metal3-dev-env-install-deep-dive.html">detailed metal3-dev-env walkthrough
blogpost</a>
which describes in detail the steps involved in the environment set-up
and management cluster configuration. Here we will use that environment
to deploy a new Kubernetes cluster using Metal³.</p>

<p>Before we get started, there are a couple of requirements we are
expecting to be fulfilled.</p>

<h2 id="requirements">Requirements</h2>

<ul>
  <li>Metal³ is already deployed and working, if not please follow the
instructions in the previously mentioned <a href="/blog/2020/02/18/metal3-dev-env-install-deep-dive.html">detailed metal3-dev-env
walkthrough blogpost</a>.</li>
  <li>The appropriate environment variables are setup via shell or in the
<code class="language-plaintext highlighter-rouge">config_${user}.sh</code> file, for example
    <ul>
      <li>CAPM3_VERSION</li>
      <li>NUM_NODES</li>
      <li>CLUSTER_NAME</li>
    </ul>
  </li>
</ul>

<h2 id="overview-of-config-and-resource-types">Overview of Config and Resource types</h2>

<p>In this section, we give a brief overview of the important config files
and resources used as part of the bare metal cluster deployment. The
following sub-sections show the config files and resources that are
created and give a brief description of some of them. This will help you
understand the technical details of the cluster deployment. You can also
choose to skip this section, visit the next section about <em>provisioning</em>
first and then revisit this.</p>

<h3 id="config-files-and-resources-types">Config Files and Resources Types</h3>

<p><img src="/assets/2020-06-18-Metal3-dev-env-BareMetal-Cluster-Deployment/manifest-directory.png" alt="&quot;The directory tree for the ansible role used for deployment&quot;" /></p>

<blockquote>
  <p>info “Information” Among these the config files are rendered under the
path
<code class="language-plaintext highlighter-rouge">https://github.com/metal3-io/metal3-dev-env/tree/master/vm-setup/roles/v1aX_integration_test/files</code>
as part of the provisioning process.</p>
</blockquote>

<p>A description of some of the files part of provisioning a cluster, in a
centos-based environment:</p>

<!-- markdownlint-disable MD013 -->

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
      <th>Path</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>provisioning scripts</td>
      <td>Scripts to trigger provisioning of cluster, control plane or worker</td>
      <td><code class="language-plaintext highlighter-rouge">${metal3-dev-env}/scripts/provision/</code></td>
    </tr>
    <tr>
      <td>deprovisioning scripts</td>
      <td>Scripts to trigger deprovisioning of cluster, control plane or worker</td>
      <td><code class="language-plaintext highlighter-rouge">${metal3-dev-env}/scripts/deprovision/</code></td>
    </tr>
    <tr>
      <td><a href="https://github.com/metal3-io/metal3-dev-env/tree/main/tests/roles/run_tests/templates">templates directory</a></td>
      <td>Templates for cluster, control plane, worker definitions</td>
      <td><code class="language-plaintext highlighter-rouge">${metal3-dev-env}/tests/roles/run_tests/templates</code></td>
    </tr>
    <tr>
      <td>clusterctl env file</td>
      <td>Cluster parameters and details</td>
      <td><code class="language-plaintext highlighter-rouge">${Manifests}/clusterctl_env_centos.rc</code></td>
    </tr>
    <tr>
      <td><a href="https://github.com/metal3-io/metal3-dev-env/blob/main/tests/roles/run_tests/tasks/generate_templates.yml">generate templates</a></td>
      <td>Renders cluster, control plane and worker definitions in the <code class="language-plaintext highlighter-rouge">Manifest</code> directory</td>
      <td><code class="language-plaintext highlighter-rouge">${metal3-dev-env}/tests/roles/run_tests/tasks/generate_templates.yml</code></td>
    </tr>
    <tr>
      <td><a href="https://github.com/metal3-io/metal3-dev-env/blob/main/tests/roles/run_tests/vars/main.yml">main vars file</a></td>
      <td>Variable file that assigns all the defaults used during deployment</td>
      <td><code class="language-plaintext highlighter-rouge">${metal3-dev-env}/tests/roles/run_tests/vars/main.yml</code></td>
    </tr>
  </tbody>
</table>

<p>Here are some of the resources that are created as part of provisioning :</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Cluster</td>
      <td>a Cluster API resource for managing a cluster</td>
    </tr>
    <tr>
      <td>Metal3Cluster</td>
      <td>Corresponding Metal3 resource generated as part of bare metal cluster deployment, and managed by <code class="language-plaintext highlighter-rouge">Cluster</code></td>
    </tr>
    <tr>
      <td>KubeadmControlPlane</td>
      <td>Cluster API resource for managing the control plane, it also manages the <code class="language-plaintext highlighter-rouge">Machine</code> object, and has the <strong>KubeadmConfig</strong></td>
    </tr>
    <tr>
      <td>MachineDeployment</td>
      <td>Cluster API resource for managing workers via <code class="language-plaintext highlighter-rouge">MachineSet</code> object, it can be used to add/remove workers by scaling Up/Down</td>
    </tr>
    <tr>
      <td>MachineSet</td>
      <td>Cluster API resource for managing <code class="language-plaintext highlighter-rouge">Machine</code> objects for worker nodes</td>
    </tr>
    <tr>
      <td>Machine</td>
      <td>Cluster API resource for managing nodes - control plane or workers. In case of Controlplane, its directly managed by <code class="language-plaintext highlighter-rouge">KubeadmControlPlane</code>, whereas for Workers it’s managed by a <code class="language-plaintext highlighter-rouge">MachineSet</code></td>
    </tr>
    <tr>
      <td>Metal3Machine</td>
      <td>Corresponding Metal3 resource for managing bare metal nodes, it’s managed by a <code class="language-plaintext highlighter-rouge">Machine</code> resource</td>
    </tr>
    <tr>
      <td>Metal3MachineTemplate</td>
      <td>Metal3 resource which acts as a template when creating a control plane or a worker node</td>
    </tr>
    <tr>
      <td>KubeadmConfigTemplate</td>
      <td>A template of <code class="language-plaintext highlighter-rouge">KubeadmConfig</code>, for Workers, used to generate KubeadmConfig when a new worker node is provisioned</td>
    </tr>
  </tbody>
</table>

<!-- markdownlint-enable MD013 -->

<div class="premonition note"><div class="fa fa-check-square"></div><div class="content"><p class="header">Note</p><p>The corresponding <code class="language-plaintext highlighter-rouge">KubeadmConfig</code> is copied to the control
plane/worker at the time of provisioning.</p>


</div></div>
<h2 id="bare-metal-cluster-deployment">Bare Metal Cluster Deployment</h2>

<p>The deployment scripts primarily use ansible and the existing Kubernetes
management cluster (based on minikube ) for deploying the bare-metal
cluster. Make sure that some of the environment variables used for
Metal³ deployment are set, if you didn’t use <code class="language-plaintext highlighter-rouge">config_${user}.sh</code> for
setting the environment variables.</p>

<table>
  <thead>
    <tr>
      <th>Parameter</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>CAPM3_VERSION</td>
      <td>Version of Metal3 API</td>
      <td>v1alpha3</td>
    </tr>
    <tr>
      <td>POD_CIDR</td>
      <td>Pod Network CIDR</td>
      <td>192.168.0.0/18</td>
    </tr>
    <tr>
      <td>CLUSTER_NAME</td>
      <td>Name of bare metal cluster</td>
      <td>test1</td>
    </tr>
  </tbody>
</table>

<p>===</p>

<h3 id="steps-involved">Steps Involved</h3>

<p>All the scripts for cluster provisioning or de-provisioning are located
at -
<a href="https://github.com/metal3-io/metal3-dev-env/tree/main/tests/scripts"><code class="language-plaintext highlighter-rouge">${metal3-dev-env}/scripts/</code></a>.
The scripts call a common playbook which handles all the tasks that are
available.</p>

<p>The steps involved in the process are:</p>

<ul>
  <li>The script calls an ansible playbook with necessary parameters ( from
env variables and defaults )</li>
  <li>The playbook executes the role -,
<a href="https://github.com/metal3-io/metal3-dev-env/tree/main/tests/roles/run_tests"><code class="language-plaintext highlighter-rouge">${metal3-dev-env}/tests/roles/run_tests</code></a>,
which runs the main
<a href="https://github.com/metal3-io/metal3-dev-env/blob/main/tests/roles/run_tests/tasks/main.yml">task_file</a>
for provisioning/deprovisioning the cluster, control plane or a worker</li>
  <li>There are
<a href="https://github.com/metal3-io/metal3-dev-env/tree/main/tests/roles/run_tests/templates">templates</a>
in the role, which are used to render configurations in the <code class="language-plaintext highlighter-rouge">Manifest</code>
directory. These configurations use kubeadm and are supplied to the
Kubernetes module of ansible to create the cluster.</li>
  <li>During provisioning, first the <code class="language-plaintext highlighter-rouge">clusterctl</code> env file is generated,
then the cluster, control plane and worker definition templates for
<code class="language-plaintext highlighter-rouge">clusterctl</code> are generated at
<code class="language-plaintext highlighter-rouge">${HOME}/.cluster-api/overrides/infrastructure-metal3/${CAPM3RELEASE}</code>.</li>
  <li>Using the templates generated in the previous step, the definitions
for resources related to cluster, control plane and worker are
rendered using <code class="language-plaintext highlighter-rouge">clusterctl</code>.</li>
  <li>Centos or Ubuntu image <a href="https://github.com/metal3-io/metal3-dev-env/blob/main/tests/roles/run_tests/tasks/download_image.yml">is
downloaded</a>
in the next step.</li>
  <li>Finally using the above definitions, which are passed to the <code class="language-plaintext highlighter-rouge">K8s</code>
module in ansible, the corresponding resource( cluster/control
plane/worker ) is provisioned.</li>
  <li>These same definitions are reused at the time of de-provisioning the
corresponding resource, again using the <code class="language-plaintext highlighter-rouge">K8s</code> module in ansible
    <blockquote>
      <p>note “Note” The manifest directory is created when provisioning is
triggered for the first time and is subsequently used to store the
config files that are rendered for deploying the bare metal cluster.</p>
    </blockquote>
  </li>
</ul>

<p><img src="/assets/2020-06-18-Metal3-dev-env-BareMetal-Cluster-Deployment/metal3-bmetal-arch-overview.png" alt="&quot;An Overview of various resources generated while provisioning and
their relationship amongst
themselves&quot;" /></p>

<h3 id="provision-cluster">Provision Cluster</h3>

<p>This script, located at the path -
<code class="language-plaintext highlighter-rouge">${metal3-dev-env}/scripts/provision/cluster.sh</code>, provisions the cluster
by creating a <code class="language-plaintext highlighter-rouge">Metal3Cluster</code> and a <code class="language-plaintext highlighter-rouge">Cluster</code> resource.</p>

<p>To see if you have a successful Cluster resource creation( the cluster
still doesn’t have a control plane or workers ), just do:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="gp">kubectl get Metal3Cluster $</span><span class="o">{</span>CLUSTER_NAME<span class="o">}</span> <span class="nt">-n</span> metal3
</code></pre></div></div>

<blockquote>
  <p>This will return the cluster deployed, and you can check the cluster
details by describing the returned resource.</p>
</blockquote>

<p>Here is what a <code class="language-plaintext highlighter-rouge">Cluster</code> resource looks like:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="gp">kubectl describe Cluster $</span><span class="o">{</span>CLUSTER_NAME<span class="o">}</span> <span class="nt">-n</span> metal3
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">cluster.x-k8s.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Cluster</span>
<span class="na">metadata</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">......</span><span class="pi">]</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">clusterNetwork</span><span class="pi">:</span>
    <span class="na">pods</span><span class="pi">:</span>
      <span class="na">cidrBlocks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">192.168.0.0/18</span>
    <span class="na">services</span><span class="pi">:</span>
      <span class="na">cidrBlocks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">10.96.0.0/12</span>
  <span class="na">controlPlaneEndpoint</span><span class="pi">:</span>
    <span class="na">host</span><span class="pi">:</span> <span class="s">192.168.111.249</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">6443</span>
  <span class="na">controlPlaneRef</span><span class="pi">:</span>
    <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">controlplane.cluster.x-k8s.io/v1alpha3</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">KubeadmControlPlane</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">bmetalcluster</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">metal3</span>
  <span class="na">infrastructureRef</span><span class="pi">:</span>
    <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">infrastructure.cluster.x-k8s.io/v1alpha3</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">Metal3Cluster</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">bmetalcluster</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">metal3</span>
<span class="na">status</span><span class="pi">:</span>
  <span class="na">infrastructureReady</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">phase</span><span class="pi">:</span> <span class="s">Provisioned</span>
</code></pre></div></div>

<h3 id="provision-controlplane">Provision Controlplane</h3>

<p>This script, located at the path -
<code class="language-plaintext highlighter-rouge">${metal3-dev-env}/scripts/provision/controlplane.sh</code>, provisions the
control plane member of the cluster using the rendered definition of the
control plane explained in the <strong>Steps Involved</strong> section. The
<code class="language-plaintext highlighter-rouge">KubeadmControlPlane</code> creates a <code class="language-plaintext highlighter-rouge">Machine</code> which picks up a BareMetalHost
satisfying its requirements as the control plane node, and it is then
provisioned by the Bare Metal Operator. A <code class="language-plaintext highlighter-rouge">Metal3MachineTemplate</code>
resource is also created as part of the provisioning process.</p>

<div class="premonition note"><div class="fa fa-check-square"></div><div class="content"><p class="header">Note</p><p>It takes some time for the provisioning of the control plane, you can
watch the process using some steps shared a bit later</p>


</div></div>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="gp">kubectl get KubeadmControlPlane $</span><span class="o">{</span>CLUSTER_NAME<span class="o">}</span> <span class="nt">-n</span> metal3
<span class="gp">kubectl describe KubeadmControlPlane $</span><span class="o">{</span>CLUSTER_NAME<span class="o">}</span> <span class="nt">-n</span> metal3
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">controlplane.cluster.x-k8s.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">KubeadmControlPlane</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="pi">[</span><span class="nv">....</span><span class="pi">]</span>
  <span class="na">ownerReferences</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">cluster.x-k8s.io/v1alpha3</span>
    <span class="na">blockOwnerDeletion</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">controller</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">Cluster</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">bmetalcluster</span>
    <span class="na">uid</span><span class="pi">:</span> <span class="s">aec0f73b-a068-4992-840d-6330bf943d22</span>
  <span class="na">resourceVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">44555"</span>
  <span class="na">selfLink</span><span class="pi">:</span> <span class="s">/apis/controlplane.cluster.x-k8s.io/v1alpha3/namespaces/metal3/kubeadmcontrolplanes/bmetalcluster</span>
  <span class="na">uid</span><span class="pi">:</span> <span class="s">99487c75-30f1-4765-b895-0b83b0e5402b</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">infrastructureTemplate</span><span class="pi">:</span>
    <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">infrastructure.cluster.x-k8s.io/v1alpha3</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">Metal3MachineTemplate</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">bmetalcluster-controlplane</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">metal3</span>
  <span class="na">kubeadmConfigSpec</span><span class="pi">:</span>
    <span class="na">files</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">content</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">[....]</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">v1.18.0</span>
<span class="na">status</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span> <span class="s">cluster.x-k8s.io/cluster-name=bmetalcluster,cluster.x-k8s.io/control-plane=</span>
  <span class="na">unavailableReplicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">updatedReplicas</span><span class="pi">:</span> <span class="m">1</span>
</code></pre></div></div>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="gp">kubectl get Metal3MachineTemplate $</span><span class="o">{</span>CLUSTER_NAME<span class="o">}</span><span class="nt">-controlplane</span> <span class="nt">-n</span> metal3
</code></pre></div></div>

<p>To track the progress of provisioning, you can try the following:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="go">kubectl get BareMetalHosts -n metal3 -w
</span></code></pre></div></div>

<blockquote>
  <p>The <code class="language-plaintext highlighter-rouge">BareMetalHosts</code> resource is created when <code class="language-plaintext highlighter-rouge">Metal³/metal3-dev-env</code>
was deployed. It is a kubernetes resource that represents a bare metal
Machine, with all its details and configuration, and is managed by the
<code class="language-plaintext highlighter-rouge">Bare Metal Operator</code>. You can also use the short representation
instead, i.e. <code class="language-plaintext highlighter-rouge">bmh</code> ( short for <code class="language-plaintext highlighter-rouge">BareMetalHosts</code>) in the command
above.
You should see all the nodes that were created at the time of metal3
deployment, along with their current status as the provisioning
progresses</p>
</blockquote>
<div class="premonition note"><div class="fa fa-check-square"></div><div class="content"><p class="header">Note</p><p>All the bare metal hosts listed above were created when Metal³ was
deployed in the <em>detailed metal3-dev-env walkthrough blogpost</em>.</p>


</div></div>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="go">kubectl get Machine -n metal3 -w
</span></code></pre></div></div>

<blockquote>
  <p>This shows the status of the Machine associated with the control plane
and we can watch the status of provisioning under PHASE</p>
</blockquote>

<p>Once the provisioning is finished, let’s get the host-ip:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="go">sudo virsh net-dhcp-leases baremetal
</span></code></pre></div></div>

<div class="premonition info"><div class="fa fa-info-circle"></div><div class="content"><p class="header">Information</p><p><code class="language-plaintext highlighter-rouge">baremetal</code> is one of the 2 networks that were created at the time of
Metal3 deployment, the other being “provisioning” which is used - as
you have guessed - for provisioning the bare metal cluster. More
details about networking setup in the metal3-dev-env environment are
described in the - <a href="/blog/2020/02/18/metal3-dev-env-install-deep-dive.html">detailed metal3-dev-env walkthrough
blogpost</a>.</p>


</div></div>
<p>You can log in to the control plane node if you want, and can check the
deployment status using two methods.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="go">ssh metal3@{control-plane-node-ip}
ssh metal3@192.168.111.249
</span></code></pre></div></div>

<h3 id="provision-workers">Provision Workers</h3>

<p>The script is located at
<code class="language-plaintext highlighter-rouge">${metal3-dev-env-path}/scripts/provision/worker.sh</code> and it provisions a
node to be added as a worker to the bare metal cluster. It selects one
of the remaining nodes and provisions it and adds it to the bare metal
cluster ( which only has a control plane node at this point ). The
resources created for workers are - <code class="language-plaintext highlighter-rouge">MachineDeployment</code> which can be
scaled up to add more workers to the cluster and <code class="language-plaintext highlighter-rouge">MachineSet</code> which then
creates a <code class="language-plaintext highlighter-rouge">Machine</code> managing the node.</p>

<div class="premonition info"><div class="fa fa-info-circle"></div><div class="content"><p class="header">Information</p><p>Similar to control plane provisioning, worker provisioning also takes
some time, and you can watch the process using steps shared a bit
later. This will also apply when you scale Up/Down workers at a later
point in time.</p>


</div></div>
<p>This is what a <code class="language-plaintext highlighter-rouge">MachineDeployment</code> looks like</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="gp">kubectl describe MachineDeployment $</span><span class="o">{</span>CLUSTER_NAME<span class="o">}</span> <span class="nt">-n</span> metal3
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">cluster.x-k8s.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">MachineDeployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="pi">[</span><span class="nv">....</span><span class="pi">]</span>
  <span class="na">ownerReferences</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">cluster.x-k8s.io/v1alpha3</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">Cluster</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">bmetalcluster</span>
    <span class="na">uid</span><span class="pi">:</span> <span class="s">aec0f73b-a068-4992-840d-6330bf943d22</span>
  <span class="na">resourceVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">66257"</span>
  <span class="na">selfLink</span><span class="pi">:</span> <span class="s">/apis/cluster.x-k8s.io/v1alpha3/namespaces/metal3/machinedeployments/bmetalcluster</span>
  <span class="na">uid</span><span class="pi">:</span> <span class="s">f598da43-0afe-44e4-b793-cd5244c13f4e</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">clusterName</span><span class="pi">:</span> <span class="s">bmetalcluster</span>
  <span class="na">minReadySeconds</span><span class="pi">:</span> <span class="m">0</span>
  <span class="na">progressDeadlineSeconds</span><span class="pi">:</span> <span class="m">600</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">revisionHistoryLimit</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">cluster.x-k8s.io/cluster-name</span><span class="pi">:</span> <span class="s">bmetalcluster</span>
      <span class="na">nodepool</span><span class="pi">:</span> <span class="s">nodepool-0</span>
  <span class="na">strategy</span><span class="pi">:</span>
    <span class="na">rollingUpdate</span><span class="pi">:</span>
      <span class="na">maxSurge</span><span class="pi">:</span> <span class="m">1</span>
      <span class="na">maxUnavailable</span><span class="pi">:</span> <span class="m">0</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">RollingUpdate</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">cluster.x-k8s.io/cluster-name</span><span class="pi">:</span> <span class="s">bmetalcluster</span>
        <span class="na">nodepool</span><span class="pi">:</span> <span class="s">nodepool-0</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">bootstrap</span><span class="pi">:</span>
        <span class="na">configRef</span><span class="pi">:</span>
          <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">bootstrap.cluster.x-k8s.io/v1alpha3</span>
          <span class="na">kind</span><span class="pi">:</span> <span class="s">KubeadmConfigTemplate</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">bmetalcluster-workers</span>
      <span class="na">clusterName</span><span class="pi">:</span> <span class="s">bmetalcluster</span>
      <span class="na">infrastructureRef</span><span class="pi">:</span>
        <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">infrastructure.cluster.x-k8s.io/v1alpha3</span>
        <span class="na">kind</span><span class="pi">:</span> <span class="s">Metal3MachineTemplate</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">bmetalcluster-workers</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">v1.18.0</span>
<span class="na">status</span><span class="pi">:</span>
  <span class="na">observedGeneration</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">phase</span><span class="pi">:</span> <span class="s">ScalingUp</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span> <span class="s">cluster.x-k8s.io/cluster-name=bmetalcluster,nodepool=nodepool-0</span>
  <span class="na">unavailableReplicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">updatedReplicas</span><span class="pi">:</span> <span class="m">1</span>
</code></pre></div></div>

<p>To check the status we can follow steps similar to Controlplane case:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="go">kubectl get bmh -n metal3 -w
</span></code></pre></div></div>

<blockquote>
  <p>We can see the live status of the node being provisioned. As mentioned
before <code class="language-plaintext highlighter-rouge">bmh</code> is the short representation of <code class="language-plaintext highlighter-rouge">BareMetalHosts</code>.</p>
</blockquote>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="go">kubectl get Machine -n metal3 -w
</span></code></pre></div></div>

<blockquote>
  <p>This shows the status of Machines associated with workers, apart from
the one for Controlplane, and we can watch the status of provisioning
under PHASE</p>
</blockquote>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="go">sudo virsh net-dhcp-leases baremetal
</span></code></pre></div></div>

<blockquote>
  <p>To get the node’s IP</p>
</blockquote>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="go">ssh metal3@{control-plane-node-ip}
kubectl get nodes
</span></code></pre></div></div>

<blockquote>
  <p>To check if it’s added to the cluster</p>
</blockquote>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="go">ssh metal3@{node-ip}
</span></code></pre></div></div>

<blockquote>
  <p>If you want to log in to the node</p>
</blockquote>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="gp">kubectl scale --replicas=3 MachineDeployment $</span><span class="o">{</span>CLUSTER_NAME<span class="o">}</span> <span class="nt">-n</span> metal3
</code></pre></div></div>

<blockquote>
  <p>We can add or remove workers to the cluster, and we can scale up the
MachineDeployment up or down, in this example we are adding 2 more
worker nodes, making the total nodes = 3</p>
</blockquote>

<h3 id="deprovisioning">Deprovisioning</h3>

<p>All of the previous components have corresponding de-provisioning
scripts which use config files, in the previously mentioned manifest
directory, and use them to clean up the worker, control plane and
cluster.</p>

<p>This step will use the already generated cluster/control plane/worker
definition file, and supply it to <strong>Kubernetes</strong> ansible module to
remove/de-provision the resource. You can find it, under the <code class="language-plaintext highlighter-rouge">Manifest</code>
directory, in the Snapshot shared at the beginning of this blogpost
where we show the file structure.</p>

<p>For example, if you wish to de-provision the cluster, you would do:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="gp">sh $</span><span class="o">{</span>metal3-dev-env-path<span class="o">}</span>/scripts/deprovision/worker.sh
<span class="gp">sh $</span><span class="o">{</span>metal3-dev-env-path<span class="o">}</span>/scripts/deprovision/controlplane.sh
<span class="gp">sh $</span><span class="o">{</span>metal3-dev-env-path<span class="o">}</span>/scripts/deprovision/cluster.sh
</code></pre></div></div>

<div class="premonition note"><div class="fa fa-check-square"></div><div class="content"><p class="header">Note</p><p>The reason for running the <code class="language-plaintext highlighter-rouge">deprovision/worker.sh</code> and
<code class="language-plaintext highlighter-rouge">deprovision/controlplane.sh</code> scripts is that not all objects are
cleared when we just run the <code class="language-plaintext highlighter-rouge">deprovision/cluster.sh</code> script.
Following this, if you want to de-provision the control plane it is
recommended to de-provision the cluster itself since we can’t
provision a new control plane with the same cluster. For worker
de-provisioning, we only need to run the worker script.</p>


</div></div>
<p>The following video demonstrates all the steps to provision and
de-provision a Kubernetes cluster explained above.</p>

<!-- markdownlint-disable MD033 MD013 -->

<iframe width="1110" height="625" style="height: 625px" src="https://www.youtube.com/embed/FzDQs_9XvtU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<!-- markdownlint-enable MD033 MD013 -->

<h2 id="summary">Summary</h2>

<p>In this blogpost we saw how to deploy a bare metal cluster once we have
a Metal³(metal3-dev-env repo) deployed and by that point we will already
have the nodes ready to be used for a bare metal cluster deployment.</p>

<p>In the first section, we show the various configuration files,
templates, resource types and their meanings. Then we see the common
steps involved in the provisioning process. After that, we see a general
overview of how all resources are related and at what point are they
created - provision cluster/control plane/worker.</p>

<p>In each of the provisioning sections, we see the steps to monitor the
provisioning and how to confirm if it’s successful or not, with brief
explanations wherever required. Finally, we see the de-provisioning
section which uses the resource definitions generated at the time of
provisioning to de-provision cluster, control plane or worker.</p>

<p>Here are a few resources which you might find useful if you want to
explore further, some of them have already been shared earlier.</p>

<ul>
  <li><a href="https://metal3.io/">Metal3-Documentation</a>
    <ul>
      <li><a href="https://book.metal3.io/developer_environment/tryit.html">Metal3-Try-it</a></li>
    </ul>
  </li>
  <li><a href="https://github.com/metal3-io/metal3-dev-env">Metal³/metal3-dev-env</a></li>
  <li><a href="/blog/2020/02/18/metal3-dev-env-install-deep-dive.html">Detailed metal3-dev-env walkthrough blogpost</a></li>
  <li><a href="/blog/2020/02/27/talk-kubernetes-finland-metal3.html">Kubernetes Metal3 Talk</a></li>
  <li><a href="https://github.com/metal3-io/metal3-docs">Metal3-Docs-github</a></li>
</ul>

</article>
<nav class="mk-pagination">
        
          <a class="mk-pagination__page mk-pagination__page--prev" href="/blog/2020/03/05/CAPI_provider_renaming.html" aria-label="previous page">
                <?xml version="1.0" encoding="UTF-8"?>
                <svg enable-background="new 0 0 398.7 320.1" version="1.1" viewBox="0 0 398.7 320.1" xml:space="preserve" xmlns="http://www.w3.org/2000/svg">
                <path d="m199 143.1l136-136c9.4-9.4 24.6-9.4 33.9 0l22.6 22.6c9.4 9.4 9.4 24.6 0 33.9l-96.3 96.5 96.4 96.4c9.4 9.4 9.4 24.6 0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9 0l-136-136c-9.5-9.3-9.5-24.6-0.1-33.9zm-192 34l136 136c9.4 9.4 24.6 9.4 33.9 0l22.6-22.6c9.4-9.4 9.4-24.6 0-33.9l-96.3-96.5 96.4-96.4c9.4-9.4 9.4-24.6 0-33.9l-22.6-22.7c-9.4-9.4-24.6-9.4-33.9 0l-136 136c-9.5 9.3-9.5 24.6-0.1 34z"/>
                </svg>
          </a>
        
        
          <a class="mk-pagination__page mk-pagination__page--next" href="/blog/2020/07/05/raw-image-streaming.html" aria-label="next page">
                <?xml version="1.0" encoding="UTF-8"?>
                <svg enable-background="new 0 0 398.6 320.1" version="1.1" viewBox="0 0 398.6 320.1" xml:space="preserve" xmlns="http://www.w3.org/2000/svg">
                <path d="m199.6 177.1l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.7c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.5-96.3c-9.4-9.4-9.4-24.6 0-33.9l22.6-22.8c9.4-9.4 24.6-9.4 33.9 0l136 136c9.4 9.3 9.4 24.6 0.1 34zm191.9-34l-136-136c-9.4-9.4-24.6-9.4-33.9 0l-22.6 22.5c-9.4 9.4-9.4 24.6 0 33.9l96.4 96.4-96.4 96.4c-9.4 9.4-9.4 24.6 0 33.9l22.6 22.6c9.4 9.4 24.6 9.4 33.9 0l136-136c9.4-9.2 9.4-24.4 0-33.7z"/>
                </svg>
          </a>
        
</nav>

        <aside class="mk-blog__categories mk-main__aside">
    <header class="mk-main__header">
            <h2 class="mk-heading mk-heading--xl mk-m-border">Related entries</h2>
    </header>
    <ul class="mk-blog__related-entries">

        
        
        
        
            
            
            
            
          
            
            
            
            
              <li class="mk-blog__related-entries__item"><a class="mk-blog__related-entries__link" href="/blog/2024/12/13/Introducing-BMO-E2E.html">Introducing Baremetal Operator end-to-end test suite</a></li>
              
              
            
          
            
            
            
            
              <li class="mk-blog__related-entries__item"><a class="mk-blog__related-entries__link" href="/blog/2024/10/24/Scaling-Kubernetes-with-Metal3-on-Fake-Node.html">Scaling Kubernetes with Metal3: Simulating 1000 Clusters with Fake Ironic Agents</a></li>
              
              
            
          
            
            
            
            
              <li class="mk-blog__related-entries__item"><a class="mk-blog__related-entries__link" href="/blog/2024/05/30/Scaling_part_3.html">Scaling to 1000 clusters - Part 3</a></li>
              
              
            
          
            
            
            
            
          
            
            
            
            
              <li class="mk-blog__related-entries__item"><a class="mk-blog__related-entries__link" href="/blog/2024/01/18/How_to_run_Metal3_website_locally_with_Jekyll.html">How to run Metal3 website locally with Jekyll</a></li>
              
              
                
    </ul>

</aside>

    </main>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>
<script src="/assets/js/photoswipe-page.js">
</script>

</main>
<footer class="mk-main-footer">
  <div>
    <div class="mk-cncf-footer">
      <p>We are a <a href="https://cncf.io/">Cloud Native Computing Foundation</a> sandbox project.</p>
      <p><img id= "cncf-image" src="/assets/images/cncf-color.png"/></p>
      <p>Copyright 2025 The Metal³ Contributors - <a href="/privacy-statement.html">Privacy Statement</a></p>
      <p>Copyright 2025 The Linux Foundation. All Rights Reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage">Trademark Usage</a> page.</p>
    </div>
      <div class="mk-icons-footer">
        <p>
<!--           <a href="https://twitter.com/metal3_io" aria-label="Visit us on Twitter">
            <i class="fab fa-twitter fa-lg"></i>
          </a> -->
          <a href="https://kubernetes.slack.com/messages/CHD49TLE7" data-placement="top" title="Join our Slack channel">
            <i class="fab fa-slack fa-lg"></i>
          </a>
          <a href="https://github.com/metal3-io" aria-label="View our repo on GitHub">
            <i class="fab fa-github fa-lg"></i>
          </a>
          <a href="https://groups.google.com/g/metal3-dev" aria-label="Send us an email">
            <i class="fas fa-envelope fa-lg"></i>
          </a>
          <a href="https://www.youtube.com/channel/UC_xneeYbo-Dl4g-U78xW15g/videos" aria-label="See our YouTube channel">
            <i class="fab fa-youtube fa-lg"></i>
          </a>
        </p>
      </div>
  </div>
</footer>
</div><!--wrapper-->
<script>
var toggle = document.querySelector('#toggle');
var menu = document.querySelector('#main_nav');
var menuItems = document.querySelectorAll('#main_nav li a');

toggle.addEventListener('click', function(){
if (menu.classList.contains('is-active')) {
  this.setAttribute('aria-expanded', 'false');
  menu.classList.remove('is-active');
} else {
  menu.classList.add('is-active');
  this.setAttribute('aria-expanded', 'true');
  //menuItems[0].focus();
}
});
</script>
    <script src="/assets/js/copy.js"></script>
    <!-- This comes from DTM/DPAL and must be latest entry in body-->
<script>
  let pageLocation = window.location.href
  let footerIcons = document.querySelector(".mk-icons-footer")

  if(pageLocation.includes("community-resources.html")){
    footerIcons.style.display = "none"
  }else {null}

</script>
    <script type="text/javascript">
        if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
            _satellite.pageBottom();
        }
    </script>
</body>
</html>

